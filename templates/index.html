<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScopeStack Template Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Full-screen step container */
        .step-container {
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            padding: 40px;
            padding-bottom: 120px; /* Space for fixed bottom bar */
        }

        .step-container.active {
            display: flex;
        }

        .step-container:not(.active) {
            display: none;
        }

        .container {
            max-width: 100%;
            padding: 0 20px 20px 20px;
        }

        .header {
            background: white;
            padding: 12px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 12px;
        }

        .header h1 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 2px;
        }

        .header p {
            color: #666;
            font-size: 12px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #667eea;
            margin-right: 12px;
        }

        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        input[type="file"] {
            display: none;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
            animation: shimmer 1s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }

        .analysis-results {
            display: none;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .field-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .field-list h3 {
            margin-bottom: 12px;
            color: #333;
            font-size: 18px;
        }

        .field-item {
            background: white;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .actions button {
            flex: 1;
        }

        .validation-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .validation-results {
            display: none;
            margin-top: 16px;
        }

        .coverage-bar {
            width: 100%;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 12px 0;
        }

        .coverage-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Fixed Bottom Status Bar */
        #statusBar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 3px solid #667eea;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        #statusBar:not(.visible) {
            transform: translateY(100%);
        }

        #statusBar.visible {
            transform: translateY(0);
        }

        .status-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 40px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        .status-text {
            flex: 1;
        }

        .status-message {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .status-detail {
            font-size: 13px;
            color: #666;
        }

        .tab-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            color: #666;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Auth styles */
        .auth-bar {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }

        .auth-indicator.authenticated {
            background: #28a745;
        }

        .auth-text {
            font-size: 13px;
            color: #666;
        }

        .auth-email {
            color: #333;
            font-weight: 600;
        }

        .btn-small {
            padding: 6px 14px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f0f0f0;
            color: #333;
        }

        .btn-small:hover {
            background: #e0e0e0;
        }

        .auth-bar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 6px 12px;
            font-size: 14px;
            color: #666;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: #f0f0f0;
            color: #333;
        }

        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .workflow-section {
            display: none;
        }

        .workflow-section.active {
            display: block;
        }

        .conversion-step {
            display: none;
        }

        .conversion-step.active {
            display: block;
        }

        .input-method-card {
            padding: 24px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .input-method-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-method-card.selected {
            border-color: #667eea;
            background: #f0f7ff;
        }

        .output-option-card {
            padding: 24px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
        }

        .mapping-item {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .mapping-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .mapping-item.high-confidence {
            border-left: 4px solid #28a745;
        }

        .mapping-item.medium-confidence {
            border-left: 4px solid #ffc107;
        }

        .mapping-item.low-confidence {
            border-left: 4px solid #dc3545;
        }

        .mapping-item .confidence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .mapping-item .confidence-badge.high {
            background: #d4edda;
            color: #155724;
        }

        .mapping-item .confidence-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .mapping-item .confidence-badge.low {
            background: #f8d7da;
            color: #721c24;
        }

        .mapping-override-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 8px;
        }

        .mapping-override-btn:hover {
            background: #5568d3;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            margin-bottom: 24px;
            color: #667eea;
        }

        .modal-content .form-group {
            margin-bottom: 16px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions button {
            flex: 1;
        }

        /* SSO Button Styles */
        .btn-sso {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-sso:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: #999;
            font-size: 13px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e0e0e0;
        }

        .auth-divider span {
            padding: 0 12px;
        }

        .mapping-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .mapping-item .mapping-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .mapping-item .v1-field {
            color: #dc3545;
            font-weight: bold;
        }

        .mapping-item .arrow {
            color: #667eea;
            margin: 0 12px;
        }

        .mapping-item .v2-field {
            color: #28a745;
            font-weight: bold;
        }

        .mapping-item .sample-value {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .mapping-item .confidence-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .confidence-badge.high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-badge.low {
            background: #f8d7da;
            color: #721c24;
        }

        .debug-console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
        }

        .debug-console.show {
            display: block;
        }

        .debug-console .log-line {
            margin-bottom: 4px;
        }

        .debug-console .error {
            color: #f48771;
        }

        .debug-console .success {
            color: #89d185;
        }

        .debug-console .info {
            color: #569cd6;
        }

        /* Template Selection UI Styles */
        .template-action-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .radio-option input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: 600;
        }

        .radio-option span {
            font-size: 14px;
            color: #333;
        }

        #nameCollisionWarning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 8px;
            font-size: 12px;
            color: #856404;
        }

        #templateHealthWarning {
            background: #ffebee;
            border: 1px solid #ef5350;
            border-radius: 4px;
            padding: 8px;
            font-size: 12px;
            color: #d32f2f;
        }

        #templateInfoDisplay {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px;
            font-size: 12px;
            color: #333;
        }

        #existingV2Templates {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        #existingV2Templates:focus {
            outline: none;
            border-color: #667eea;
        }

        #newTemplateName {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        #newTemplateName:focus {
            outline: none;
            border-color: #667eea;
        }

        #newTemplateName[readonly] {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .output-option-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .output-option-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .output-option-card h4 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }

        .output-option-card p {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <!-- Authentication Bar with Navigation -->
    <div class="auth-bar">
            <div class="auth-bar-left">
                <div class="nav-links">
                    <a href="/" class="nav-link active">Converter</a>
                    <a href="/merge-data-viewer" class="nav-link">Data Viewer</a>
                </div>
            </div>
            <div class="auth-status">
                <div class="auth-indicator" id="authIndicator"></div>
                <span class="auth-text" id="authText">Not authenticated</span>
                <button class="btn-small" onclick="showSettings()">Settings</button>
                <button class="btn-small" id="authButton" onclick="showLogin()">Login</button>
            </div>
        </div>

        <!-- Login Modal -->
        <div class="modal" id="loginModal">
            <div class="modal-content" style="max-width: 420px;">
                <h2>üîê Login to ScopeStack</h2>
                <p style="color: #666; margin-bottom: 24px;">Sign in to enable validation features and persistent authentication.</p>

                <!-- SSO Button (Primary) -->
                <button class="btn-sso" onclick="window.location.href='/oauth/authorize'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                        <polyline points="10 17 15 12 10 7"/>
                        <line x1="15" y1="12" x2="3" y2="12"/>
                    </svg>
                    Login with ScopeStack SSO
                </button>

                <!-- Divider -->
                <div class="auth-divider">
                    <span>or use service account</span>
                </div>

                <!-- Email/Password Form (Secondary) -->
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your.email@company.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Your password">
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeLogin()">Cancel</button>
                    <button onclick="performLogin()">Login</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <h2>‚öôÔ∏è Settings</h2>
                <p style="color: #666; margin-bottom: 24px;">Configure AI providers and ScopeStack authentication</p>

                <!-- ScopeStack Auth Section -->
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span>üîê</span> ScopeStack Authentication
                    </h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                        Status: <span id="settingsAuthStatus" style="font-weight: bold;">Not authenticated</span>
                        <span id="settingsAuthType" style="font-size: 11px; color: #999; margin-left: 8px;"></span>
                    </p>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button onclick="window.location.href='/oauth/authorize'" class="btn-sso" style="flex: 2; padding: 10px 16px; font-size: 14px;">
                            Login with SSO
                        </button>
                        <button onclick="showLogin(); closeSettings();" class="btn-secondary" style="flex: 1; padding: 10px 16px; font-size: 13px;">
                            Service Account
                        </button>
                    </div>
                    <div id="settingsAccountActions" style="display: none; gap: 8px;">
                        <button onclick="refreshAccount()" class="btn-secondary" style="flex: 1; padding: 8px 16px; font-size: 13px;">
                            Refresh Account
                        </button>
                        <button onclick="performLogout(); closeSettings();" class="btn-secondary" style="flex: 1; padding: 8px 16px; font-size: 13px;">
                            Logout
                        </button>
                    </div>
                </div>

                <!-- AI Provider Section -->
                <div style="background: #f0f7ff; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span>ü§ñ</span> AI-Powered Conversion
                    </h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                        Enable AI to automatically iterate and improve template conversions by comparing v1 and v2 outputs.
                    </p>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="enableAI" onchange="toggleAISettings()">
                            <span>Enable AI-powered iterative conversion</span>
                        </label>
                    </div>

                    <div id="aiProviderSettings" style="display: none;">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label>AI Provider</label>
                            <select id="aiProvider" onchange="updateApiKeyStatus()" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                            </select>
                        </div>

                        <!-- API Key Input (shown when no key saved) -->
                        <div id="apiKeyInputSection" style="display: none;">
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label>API Key</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="password" id="aiApiKey" placeholder="sk-..." style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace;">
                                    <button onclick="saveApiKey()" id="saveApiKeyBtn" class="btn-primary" style="white-space: nowrap;">Save Key</button>
                                </div>
                                <p style="font-size: 11px; color: #666; margin-top: 4px;">
                                    Your API key is stored securely in ~/.scopestack/tokens.json
                                </p>
                            </div>
                        </div>

                        <!-- API Key Status (shown when key saved) -->
                        <div id="apiKeyStatusSection" style="display: none;">
                            <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="color: #155724; font-size: 18px;">‚úì</span>
                                        <span style="color: #155724; font-weight: 600;" id="apiKeyProviderName">OpenAI</span>
                                        <span style="color: #155724;">API key saved</span>
                                    </div>
                                    <button onclick="changeApiKey()" class="btn-secondary" style="font-size: 12px; padding: 4px 12px;">Change Key</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Max Iterations</label>
                            <input type="number" id="maxIterations" value="4" min="1" max="10" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <p style="font-size: 11px; color: #666; margin-top: 4px;">
                                Number of times the AI will attempt to improve the conversion (1-10).
                            </p>
                        </div>
                    </div>

                    <!-- Learning Statistics -->
                    <div id="learningStatsSection" style="background: #e8f5e9; border: 1px solid #c8e6c9; padding: 12px; border-radius: 8px; margin-top: 16px; display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <h4 style="font-size: 14px; margin: 0; color: #2e7d32;">üìä Learning Cache Statistics</h4>
                            <button onclick="refreshLearningStats()" class="btn-secondary" style="font-size: 11px; padding: 4px 8px;">Refresh</button>
                        </div>
                        <div id="learningStatsContent" style="font-size: 12px; color: #666;">
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Debug Console Section -->
                <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span>üîç</span> Debug Console
                    </h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                        View API call logs for troubleshooting template upload and conversion issues.
                    </p>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button onclick="toggleDebugConsole()" id="debugConsoleToggle" class="btn-secondary" style="flex: 1;">
                            Show API Logs
                        </button>
                        <button onclick="clearDebugLogs()" class="btn-secondary">
                            Clear Logs
                        </button>
                    </div>

                    <!-- Debug Console Display -->
                    <div id="debugConsoleDisplay" style="display: none; margin-top: 12px;">
                        <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div id="debugLogsContent">Loading logs...</div>
                        </div>
                        <div style="margin-top: 8px; display: flex; justify-content: space-between; font-size: 11px; color: #666;">
                            <span id="debugLogCount">0 logs</span>
                            <button onclick="refreshDebugLogs()" class="btn-secondary" style="font-size: 11px; padding: 4px 12px;">
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeSettings()">Close</button>
                </div>
            </div>
        </div>

    <div class="header">
        <h1>ScopeStack Template Converter</h1>
        <p>Convert Microsoft Word Mail Merge templates to ScopeStack's DocX Templater format</p>
    </div>

    <div class="container">
        <!-- Alert Messages (hidden - using bottom status bar instead) -->
        <div id="alertSuccess" class="alert alert-success" style="display: none;"></div>
        <div id="alertError" class="alert alert-error" style="display: none;"></div>
        <div id="alertWarning" class="alert alert-warning" style="display: none;"></div>

        <!-- Fixed Bottom Status Bar -->
        <div id="statusBar">
            <div class="status-content">
                <div class="status-spinner" id="statusSpinner"></div>
                <div class="status-text">
                    <div class="status-message" id="statusMessage"></div>
                    <div class="status-detail" id="statusDetail"></div>
                </div>
            </div>
        </div>

        <!-- Workflow Selector - REMOVED for simplified single-workflow UX -->
        <!-- Users now go directly to the convert workflow automatically -->

        <!-- Saved Sessions Section (on home screen) -->
        <div id="homeScreenSavedSessions" class="card" style="display: none; background: #e8f5e9; border: 2px solid #4caf50;">
            <h2 style="margin-bottom: 16px;">üìÇ Resume AI Improvement Session</h2>
            <p style="color: #666; margin-bottom: 16px;">Pick up where you left off with a saved AI improvement session.</p>
            <div id="homeScreenSessionsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                <!-- Sessions will be loaded here -->
            </div>
        </div>

        <!-- Convert Template Workflow -->
        <div class="card workflow-section" id="convertWorkflow">
            <div id="convertWorkflowHeader">
                <h2>üîÑ Convert Template</h2>
                <p style="color: #666; margin-bottom: 20px;">Convert a v1 Mail Merge template to v2 DocX Templater format with smart mapping suggestions.</p>
            </div>

            <!-- Step 1: Choose Input Method -->
            <div id="step1-input" class="conversion-step active">
                <div id="inputMethodSelection">
                    <h3 style="margin-bottom: 16px;">Step 1: Choose Template Source</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div onclick="selectInputMethod('upload')" id="uploadMethodCard" class="input-method-card">
                            <div style="font-size: 48px; margin-bottom: 12px;">üì§</div>
                            <h4>Upload Local File</h4>
                            <p style="color: #666; font-size: 14px;">Upload a .docx file from your computer</p>
                        </div>
                        <div onclick="selectInputMethod('platform')" id="platformMethodCard" class="input-method-card">
                            <div style="font-size: 48px; margin-bottom: 12px;">‚òÅÔ∏è</div>
                            <h4>Select from Platform</h4>
                            <p style="color: #666; font-size: 14px;">Choose a template from ScopeStack</p>
                        </div>
                    </div>
                </div>

                <!-- Upload Interface -->
                <div id="uploadInterface" style="display: none; margin-top: 20px;">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìé</div>
                        <h3>Drop your .docx file here</h3>
                        <p>or click to browse</p>
                        <input type="file" id="fileInput" accept=".docx">
                    </div>
                </div>

                <!-- Platform Selection Interface -->
                <div id="platformInterface" style="display: none; margin-top: 20px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
                            <input type="checkbox" id="activeTemplatesFilter" checked>
                            <span>Active Templates</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
                            <input type="checkbox" id="activeOnlyConvertFilter" checked>
                            <span>v1 templates only</span>
                        </label>
                    </div>

                    <!-- Template Table -->
                    <div style="border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; max-height: 400px; overflow-y: auto;">
                        <table id="templateTable" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 13px; font-weight: 600;">Name</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 13px; font-weight: 600; width: 100px;">Template Format</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 13px; font-weight: 600; width: 100px;">Data Format</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 13px; font-weight: 600; width: 80px;">Formatting</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 13px; font-weight: 600; width: 80px;">Active</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 13px; font-weight: 600;">Filename</th>
                                </tr>
                            </thead>
                            <tbody id="templateTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 40px; text-align: center; color: #999;">
                                        Templates will load automatically...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="progress" id="progress" style="margin-top: 20px;">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>

            <!-- Step 2: Learn from Project (Optional) -->
            <div id="step2-learn" class="conversion-step" style="display: none;">
                <h3 style="margin-bottom: 16px;">Step 2: Learn Mappings (Optional)</h3>
                <p style="color: #666; margin-bottom: 16px;">Select a recent project to learn better mappings from real data before conversion.</p>
                <div class="form-group">
                    <label>Select Project (optional)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="convertProjectSelect" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">-- Select a project --</option>
                        </select>
                        <button onclick="loadRecentProjects()" id="loadProjectsBtn" class="btn-secondary" style="padding: 8px 16px; white-space: nowrap;">
                            üîÑ Load Projects
                        </button>
                    </div>
                    <small style="color: #666;">Leave empty to skip learning and use existing knowledge</small>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button onclick="proceedWithLearning()" class="btn-primary">
                        üìö Learn & Continue
                    </button>
                    <button onclick="skipLearning()" class="btn-secondary">
                        Skip Learning ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 3: Automated Improvement Progress (New Integrated Flow) -->
            <div id="step3-improvement" class="conversion-step" style="display: none;">
                <h3 style="margin-bottom: 16px;">üöÄ Improving Template</h3>
                <p style="color: #666; margin-bottom: 20px;">The system is automatically improving your template by comparing output with the V1 baseline and fixing errors iteratively.</p>

                <div id="improvementProgress">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span id="currentIteration" style="font-weight: bold; font-size: 16px;">Iteration 0/4</span>
                        <span id="currentSimilarity" style="font-weight: bold; font-size: 16px; color: #667eea;">Similarity: 0%</span>
                    </div>

                    <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin-bottom: 20px;">
                        <div id="progressFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;"></div>
                    </div>

                    <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; max-height: 400px; overflow-y: auto;">
                        <h4 style="margin-bottom: 12px; font-size: 14px; color: #666;">Progress Log:</h4>
                        <div id="iterationDetails" style="font-family: 'Courier New', monospace; font-size: 13px; color: #333;">
                            <div class="iteration-log" style="margin-bottom: 8px;">
                                <span class="timestamp" style="color: #999; margin-right: 8px;">[Initializing...]</span>
                                <span class="message">Waiting for process to start...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="finalResults" style="display: none; text-align: center; padding: 40px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; margin-top: 20px;">
                    <h3 style="color: #2e7d32; margin-bottom: 16px;">Improvement Complete! üéâ</h3>
                    <p style="font-size: 18px; margin-bottom: 8px;">Final Similarity: <strong id="finalSimilarity" style="color: #2e7d32;">0%</strong></p>
                    <p style="color: #666; margin-bottom: 24px;">Total Iterations: <strong id="totalIterations">0</strong></p>

                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="viewIterationHistory()" class="btn-secondary">üìã View History</button>
                        <button onclick="viewConversionReport()" class="btn-secondary">üîç View Conversion Report</button>
                        <button onclick="downloadFinalTemplate()" class="btn-primary">‚¨áÔ∏è Download Template</button>
                    </div>
                    <p style="color: #666; font-size: 14px; margin-top: 16px; text-align: center;">
                        ‚úì Template is already uploaded to ScopeStack (ID: <span id="finalTemplateId"></span>)
                    </p>
                </div>
            </div>

            <!-- Step 3 (Old): Review & Override Mappings - Now hidden in new flow -->
            <div id="step3-review" class="conversion-step" style="display: none;">
                <h3 style="margin-bottom: 16px;">Step 3: Review & Override Mappings</h3>
                <p style="color: #666; margin-bottom: 16px;">Select a mapping on the left to view its data structure and make changes.</p>

                <div style="background: #f0f7ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
                    <strong>Path Coherence:</strong> Mappings within the same loop structure are prioritized to maintain structural consistency.
                </div>

                <!-- 2-Column Layout - Responsive -->
                <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-bottom: 20px; max-width: 100%; overflow-x: hidden;">
                    <!-- Left Column: Mappings List -->
                    <div style="min-width: 0;">
                        <h4 style="margin-bottom: 12px; font-size: 14px; color: #666;">Mappings to Review</h4>
                        <div id="mappingReviewList" style="max-height: 600px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white;">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Right Column: Data Viewer -->
                    <div style="min-width: 0; overflow-x: auto;">
                        <div id="dataViewer" style="display: none;">
                            <!-- Top Row: V1 Merge Data -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 8px; font-size: 14px; color: #666;">V1 Field Context - Column Browser</h4>
                                <div id="v1ColumnBrowser" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0; max-height: 250px; overflow-x: auto; overflow-y: hidden; display: flex; gap: 0;">
                                    <!-- Columns will be added dynamically -->
                                </div>
                            </div>

                            <!-- Bottom Row: V2 Merge Data Column Browser -->
                            <div>
                                <h4 style="margin-bottom: 8px; font-size: 14px; color: #666;">V2 Data Structure - Column Browser</h4>
                                <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                        <input type="text" id="v2PathSearch" placeholder="Search or type path manually..." style="flex: 1; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 13px;">
                                        <button onclick="applySelectedV2Path()" class="btn-primary" style="padding: 6px 16px;">Apply</button>
                                    </div>
                                    <div id="selectedPathPreview" style="font-size: 12px; color: #666; font-family: monospace; word-break: break-all;">
                                        <!-- Selected path preview -->
                                    </div>
                                </div>
                                <div id="v2ColumnBrowser" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0; max-height: 350px; overflow-x: auto; overflow-y: hidden; display: flex; gap: 0;">
                                    <!-- Columns will be added dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Placeholder when no mapping selected -->
                        <div id="noMappingSelected" style="display: flex; align-items: center; justify-content: center; height: 600px; color: #999; font-size: 14px; border: 2px dashed #e0e0e0; border-radius: 8px;">
                            Select a mapping from the left to view details
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button onclick="proceedWithConversion()" id="finalConvertBtn" class="btn-primary">
                        ‚ú® Convert with These Mappings
                    </button>
                    <button onclick="backToLearning()" class="btn-secondary">
                        ‚Üê Back
                    </button>
                </div>
            </div>

            <!-- Step 4: Output Options -->
            <div id="step4-output" class="conversion-step" style="display: none;">
                <h3 style="margin-bottom: 16px;">Step 4: Choose Output</h3>
                <p style="color: #666; margin-bottom: 16px;">Your template has been converted! Choose how to get it.</p>

                <!-- Test Document Generation -->
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">üìÑ Test Document Generation (Before/After Comparison)</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 12px;">Generate test documents from both the v1 template (before) and v2 template (after) to compare them side-by-side.</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button onclick="generateV1Document()" class="btn-secondary" id="generateV1Btn">
                            üìù Generate V1 Document (Before)
                        </button>
                        <button onclick="generateV2Document()" class="btn-secondary" id="generateV2Btn" disabled>
                            üìù Generate V2 Document (After)
                        </button>
                    </div>
                    <div id="documentGenStatus" style="margin-top: 12px; font-size: 12px; color: #666;">
                        <!-- Status messages will appear here -->
                    </div>
                </div>

                <!-- AI-Powered Improvement (shows after documents are generated) -->
                <div id="aiImprovementSection" style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                    <h4 style="margin-bottom: 8px;">ü§ñ AI-Powered Conversion Improvement</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 12px;">
                        Recursively fix syntax errors, regenerate documents, and improve mappings using AI (up to 4 iterations).
                    </p>
                    <button onclick="startRecursiveAIImprovement()" class="btn-primary" id="aiImproveBtn" style="width: 100%;">
                        üîÑ Start Recursive AI Improvement
                    </button>
                    <div id="aiImprovementStatus" style="margin-top: 12px; font-size: 12px;">
                        <!-- AI improvement progress will appear here -->
                    </div>
                </div>

                <!-- AI Continuation (shows after improvement completes) -->
                <div id="aiContinuationSection" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                    <h4 style="margin-bottom: 8px;">üí¨ Continue Improving</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 12px;">
                        Session saved! Provide feedback or observations to guide the next round of improvements.
                    </p>
                    <div id="sessionInfo" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 12px; font-size: 12px;">
                        <!-- Session info will appear here -->
                    </div>
                    <textarea id="userFeedback" placeholder="Optional: Share your observations or suggestions for the AI...
Example: 'The customer name field is still not mapping correctly' or 'Focus on fixing the invoice table loop'"
                        style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-bottom: 12px;"></textarea>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                        <label style="font-size: 13px; color: #666;">Additional iterations:</label>
                        <input type="number" id="additionalIterations" min="1" max="20" value="4" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="continueImprovement()" class="btn-primary" id="continueBtn" style="flex: 1;">
                            üîÑ Continue with Feedback
                        </button>
                    </div>
                    <button onclick="saveSessionForLater()" class="btn-secondary" style="width: 100%;">
                        üíæ Save Session & Continue Later
                    </button>
                </div>

                <!-- Saved Sessions (shows available sessions) -->
                <div id="savedSessionsSection" style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                    <h4 style="margin-bottom: 8px;">üìÇ Saved Sessions</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 12px;">
                        Resume a previously saved improvement session.
                    </p>
                    <div id="sessionsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Sessions list will appear here -->
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="output-option-card" id="downloadOptionCard">
                        <div style="font-size: 48px; margin-bottom: 12px;">‚¨áÔ∏è</div>
                        <h4>Download File</h4>
                        <p style="color: #666; font-size: 14px;">Download the converted template to your computer</p>
                        <button onclick="downloadConvertedTemplate()" class="btn-primary" style="margin-top: 12px;">
                            Download .docx
                        </button>
                    </div>
                    <div class="output-option-card" id="uploadOptionCard">
                        <div style="font-size: 48px; margin-bottom: 12px;">‚òÅÔ∏è</div>
                        <h4>Upload to Platform</h4>
                        <p style="color: #666; font-size: 14px;">Upload converted template back to ScopeStack</p>

                        <!-- Template Action Selection -->
                        <div class="template-action-selector" style="margin-top: 12px;">
                            <label class="radio-option">
                                <input type="radio" name="v2_action" value="create" checked>
                                <span><strong>Create New Template</strong> (Recommended)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="v2_action" value="replace">
                                <span><strong>Replace Existing Template</strong></span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="v2_action" value="download">
                                <span><strong>Download Only</strong> (No upload)</span>
                            </label>
                        </div>

                        <!-- Create New Template Section -->
                        <div id="createNewSection" style="margin-top: 12px;">
                            <input type="text" id="newTemplateName" placeholder="Template name (auto-generated)"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" readonly>
                            <div id="nameCollisionWarning" style="display: none; background: #fff3cd; padding: 8px; margin-top: 8px; border-radius: 4px; font-size: 12px;">
                                ‚ö†Ô∏è A template with this name already exists. It will be enumerated automatically.
                            </div>
                        </div>

                        <!-- Replace Existing Template Section -->
                        <div id="replaceExistingSection" style="margin-top: 12px; display: none;">
                            <select id="existingV2Templates" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select a V2 template to replace...</option>
                            </select>
                            <div id="templateHealthWarning" style="display: none; background: #ffebee; padding: 8px; margin-top: 8px; border-radius: 4px; font-size: 12px; color: #d32f2f;">
                                <!-- Health warning will appear here -->
                            </div>
                        </div>

                        <!-- Template Info Display -->
                        <div id="templateInfoDisplay" style="margin-top: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 12px; display: none;">
                            <!-- Template details will appear here -->
                        </div>

                        <button onclick="uploadToPlatform()" class="btn-primary" id="uploadBtn" style="margin-top: 12px; width: 100%;">
                            Upload to ScopeStack
                        </button>
                    </div>
                </div>

                <button onclick="startNewConversion()" class="btn-secondary">
                    üîÑ Convert Another Template
                </button>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="card analysis-results" id="analysisResults">
            <h2>Step 2: Review Analysis</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalFields">0</div>
                    <div class="stat-label">Total Fields</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="simpleFields">0</div>
                    <div class="stat-label">Simple Fields</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="loopFields">0</div>
                    <div class="stat-label">Loop Fields</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="conditionalFields">0</div>
                    <div class="stat-label">Conditional Fields</div>
                </div>
            </div>

            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('simple')">Simple Fields</button>
                <button class="tab-button" onclick="showTab('loops')">Loops</button>
                <button class="tab-button" onclick="showTab('conditionals')">Conditionals</button>
            </div>

            <div id="simpleTab" class="tab-content active">
                <div class="field-list" id="simpleFieldsList"></div>
            </div>
            <div id="loopsTab" class="tab-content">
                <div class="field-list" id="loopFieldsList"></div>
            </div>
            <div id="conditionalsTab" class="tab-content">
                <div class="field-list" id="conditionalFieldsList"></div>
            </div>

            <div class="actions">
                <button onclick="convertTemplate()" id="convertBtn">
                    üîÑ Convert Template
                </button>
                <button class="btn-secondary" onclick="toggleValidation()">
                    ‚úì Validate Against Project
                </button>
            </div>

            <!-- Validation Section -->
            <div class="validation-section" id="validationSection">
                <h3 style="margin-bottom: 16px;">Validate Against ScopeStack Project</h3>
                <p style="color: #666; margin-bottom: 16px;" id="validationAuthNote">
                    <span id="validationAuthRequired" style="display: none;">‚ö†Ô∏è Please login first to use validation features.</span>
                    <span id="validationAuthReady" style="display: none;">‚úì Authenticated - ready to validate!</span>
                </p>
                <div class="form-group">
                    <label>Project ID</label>
                    <input type="text" id="projectId" placeholder="e.g., 101735">
                </div>
                <button onclick="validateTemplate()" id="validateBtn">
                    Run Validation
                </button>

                <div class="validation-results" id="validationResults">
                    <h4 style="margin-top: 20px; margin-bottom: 12px;">Validation Results</h4>
                    <div class="coverage-bar">
                        <div class="coverage-fill" id="coverageFill">0%</div>
                    </div>
                    <p><strong>Valid Fields:</strong> <span id="validCount">0</span></p>
                    <p><strong>Missing Fields:</strong> <span id="missingCount">0</span></p>
                    <div id="missingFieldsList" style="margin-top: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- Learn Mappings Workflow -->
        <div class="card workflow-section" id="learnWorkflow" style="display: none;">
            <h2>üéì Learn Field Mappings</h2>

            <div class="tab-buttons">
                <button class="tab-button active" onclick="showLearningTab('api')">From Project Data</button>
                <button class="tab-button" onclick="showLearningTab('upload')">From Documents</button>
            </div>

            <!-- API Learning Tab -->
            <div id="apiLearningTab" class="tab-content active" style="margin-top: 20px;">
                <p style="color: #666; margin-bottom: 20px;">
                    Automatically discover v2 field mappings by comparing values in v1 and v2 merge data from a live project.
                </p>
                <p style="color: #666; margin-bottom: 20px;" id="learnAuthNote">
                    <span id="learnAuthRequired" style="display: none;">‚ö†Ô∏è Please login first to use this feature.</span>
                    <span id="learnAuthReady" style="display: none;">‚úì Authenticated - ready to learn mappings!</span>
                </p>
                <div class="form-group">
                    <label>Project ID</label>
                    <input type="text" id="learnProjectId" placeholder="e.g., 103063">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="testProject()" id="testProjectBtn" class="btn-secondary">
                        üß™ Test Project
                    </button>
                    <button onclick="learnMappings()" id="learnMappingsBtn" style="flex: 1;">
                        üîç Discover Mappings
                    </button>
                </div>
            </div>

            <!-- Document Upload Learning Tab -->
            <div id="uploadLearningTab" class="tab-content" style="margin-top: 20px;">
                <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
                    <strong>Integrated Learning Workflow:</strong>
                    <ol style="margin: 10px 0 0 20px; color: #555;">
                        <li>Upload your v1 template and its generated output document</li>
                        <li>System extracts field names from template and values from output</li>
                        <li>Fetches both v1 and v2 merge data from API using project ID</li>
                        <li>Matches: v1 field ‚Üí actual value (in output) ‚Üí v2 path</li>
                        <li>Saves confirmed mappings to persistent database</li>
                    </ol>
                    <p style="margin: 10px 0 0 0; color: #666; font-style: italic;">
                        This gives you the most accurate mappings because we verify the actual values rendered in your output.
                    </p>
                </div>
                <p style="color: #666; margin-bottom: 20px;" id="uploadAuthNote">
                    <span id="uploadAuthRequired" style="display: none;">‚ö†Ô∏è Please login first to use this feature.</span>
                    <span id="uploadAuthReady" style="display: none;">‚úì Authenticated - ready to learn!</span>
                </p>

                <div class="form-group">
                    <label>Project ID</label>
                    <input type="text" id="uploadProjectId" placeholder="e.g., 103063">
                </div>

                <div class="form-group">
                    <label>v1 Template (.docx) <span style="color: #dc3545;">*</span></label>
                    <input type="file" id="v1TemplateFile" accept=".docx" style="display: block; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%;">
                </div>

                <div class="form-group">
                    <label>Generated Output Document (.docx) <span style="color: #dc3545;">*</span></label>
                    <input type="file" id="outputDocFile" accept=".docx" style="display: block; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%;">
                </div>

                <div class="form-group">
                    <label>v2 Template (.docx) <span style="color: #999; font-size: 12px;">(Optional - for reference)</span></label>
                    <input type="file" id="v2TemplateFile" accept=".docx" style="display: block; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%;">
                </div>

                <button onclick="uploadForLearning()" id="uploadLearnBtn">
                    üì§ Upload & Learn Mappings
                </button>

                <!-- Database Stats -->
                <div id="databaseStats" style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; display: none;">
                    <h4 style="margin-bottom: 12px;">Mapping Database Statistics</h4>
                    <p><strong>Total Mappings:</strong> <span id="dbTotalMappings">0</span></p>
                    <p><strong>High Confidence (seen 2+ times):</strong> <span id="dbHighConf">0</span></p>
                    <p><strong>Very High Confidence (seen 5+ times):</strong> <span id="dbVeryHighConf">0</span></p>
                    <p><strong>Projects Analyzed:</strong> <span id="dbProjectsCount">0</span></p>
                    <p style="margin-top: 12px; color: #666; font-size: 12px;">These mappings are saved and will improve future conversions!</p>
                </div>
            </div>

            <!-- Debug Console -->
            <div class="debug-console" id="debugConsole"></div>

            <!-- Learning Results -->
            <div class="validation-results" id="learningResults">
                <h3 style="margin-top: 20px; margin-bottom: 12px;">Discovered Mappings</h3>

                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="stat-value" id="highConfCount">0</div>
                        <div class="stat-label">High Confidence</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        <div class="stat-value" id="mediumConfCount">0</div>
                        <div class="stat-label">Medium Confidence</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <div class="stat-value" id="lowConfCount">0</div>
                        <div class="stat-label">Low Confidence</div>
                    </div>
                </div>

                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showMappingTab('high')">High Confidence</button>
                    <button class="tab-button" onclick="showMappingTab('medium')">Medium Confidence</button>
                    <button class="tab-button" onclick="showMappingTab('low')">Low Confidence</button>
                </div>

                <div id="highMappingsTab" class="tab-content active">
                    <div class="field-list" id="highMappingsList"></div>
                </div>
                <div id="mediumMappingsTab" class="tab-content">
                    <div class="field-list" id="mediumMappingsList"></div>
                </div>
                <div id="lowMappingsTab" class="tab-content">
                    <div class="field-list" id="lowMappingsList"></div>
                </div>

                <button class="btn-success" onclick="exportMappings()" style="margin-top: 16px;">
                    üíæ Export Mappings as JSON
                </button>
            </div>
        </div>

        <!-- Production Migration Workflow -->
        <div class="card workflow-section" id="migrateWorkflow" style="display: none;">
            <h2>üöÄ Production Migration</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Complete end-to-end workflow: Select a v1 template from the platform, automatically learn mappings from a project, convert to v2 format, and upload back to ScopeStack for testing.
            </p>

            <div class="form-group">
                <label>Step 1: Select v1 Template from Platform</label>
                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <button onclick="loadTemplateList()" id="loadTemplatesBtn" class="btn-secondary">
                        üìã Load Templates
                    </button>
                    <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
                        <input type="checkbox" id="activeOnlyFilter" checked>
                        <span>Active Templates</span>
                    </label>
                </div>
                <select id="templateSelect" size="8" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 13px;">
                    <option value="">Load templates first...</option>
                </select>
                <div id="templateDetails" style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; display: none;">
                    <p><strong>Template:</strong> <span id="detailName"></span></p>
                    <p><strong>ID:</strong> <span id="detailId"></span></p>
                    <p><strong>Format:</strong> <span id="detailFormat"></span></p>
                    <p><strong>File:</strong> <span id="detailFilename"></span></p>
                </div>
            </div>

            <div class="form-group">
                <label>Step 2: Project ID (for learning mappings)</label>
                <input type="text" id="workflowProjectId" placeholder="e.g., 103063">
            </div>

            <div class="form-group">
                <label>Step 3: New Template Name</label>
                <input type="text" id="newTemplateName" placeholder="e.g., Professional Services Template V2">
            </div>

            <button onclick="runCompleteWorkflow()" id="workflowBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                üöÄ Run Complete Workflow
            </button>

            <div style="margin-top: 16px; padding: 12px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #0066cc;">
                <strong>What this does:</strong>
                <ol style="margin: 10px 0 0 20px; color: #555;">
                    <li>Downloads the selected v1 template from ScopeStack</li>
                    <li>Learns field mappings from the specified project</li>
                    <li>Converts the template to v2 format</li>
                    <li>Uploads the converted template back to ScopeStack (as inactive)</li>
                    <li>You can then test it on a project!</li>
                </ol>
            </div>

            <!-- Workflow Results -->
            <div id="workflowResults" style="margin-top: 20px; display: none;">
                <h3 style="color: #28a745;">‚úÖ Workflow Complete!</h3>
                <div style="padding: 16px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; margin-top: 12px;">
                    <p><strong>Original v1 Template ID:</strong> <span id="resultV1Id"></span></p>
                    <p><strong>New v2 Template ID:</strong> <span id="resultV2Id"></span></p>
                    <p><strong>Template Name:</strong> <span id="resultName"></span></p>
                    <p><strong>Mappings Learned:</strong> <span id="resultMappings"></span></p>
                    <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #c3e6cb;">
                        <strong>Next Steps:</strong>
                    </p>
                    <ul style="margin-left: 20px;">
                        <li>Go to ScopeStack and find template ID <strong><span id="resultV2IdCopy"></span></strong></li>
                        <li>Activate the template if it looks good</li>
                        <li>Generate a document for a project to test it</li>
                        <li>Compare with the original v1 output</li>
                    </ul>
                </div>
            </div>

            <!-- Debug Console for Workflow -->
            <div class="debug-console" id="workflowDebugConsole"></div>
        </div>

        <!-- Download Section -->
        <div class="card hidden" id="downloadSection">
            <h2>Step 3: Download Converted Template</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Your template has been successfully converted!
                <span id="warningCount"></span>
            </p>
            <button class="btn-success" onclick="downloadTemplate()">
                ‚¨áÔ∏è Download Converted Template
            </button>
            <button class="btn-secondary" onclick="reset()" style="margin-left: 12px;">
                üîÑ Convert Another Template
            </button>
            <div id="warningsList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let analysisData = null;
        let isAuthenticated = false;

        // Workflow Management
        function showWorkflow(workflow) {
            // Hide all workflows
            document.querySelectorAll('.workflow-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected workflow
            const workflowMap = {
                'convert': 'convertWorkflow',
                'migrate': 'migrateWorkflow',
                'learn': 'learnWorkflow'
            };

            const sectionId = workflowMap[workflow];
            if (sectionId) {
                document.getElementById(sectionId).style.display = 'block';
                // Scroll to the workflow section
                document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Check authentication status on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            // Show convert workflow by default (simplified single-workflow UX)
            showWorkflow('convert');
            // Make convert workflow visible immediately
            document.getElementById('convertWorkflow').style.display = 'block';

            // Check for OAuth callback success
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auth') === 'success') {
                // Clean up URL (remove query parameter)
                window.history.replaceState({}, document.title, window.location.pathname);
                // Show success message after auth check completes
                setTimeout(() => {
                    showAlert('success', 'Successfully logged in via SSO!');
                }, 500);
            }
        });

        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (data.authenticated) {
                    updateAuthUI(true, data.account);
                } else {
                    updateAuthUI(false);
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                updateAuthUI(false);
            }
        }

        function updateAuthUI(authenticated, account = null) {
            isAuthenticated = authenticated;
            const indicator = document.getElementById('authIndicator');
            const text = document.getElementById('authText');
            const button = document.getElementById('authButton');
            const settingsAuthStatus = document.getElementById('settingsAuthStatus');
            const settingsAuthType = document.getElementById('settingsAuthType');
            const settingsAccountActions = document.getElementById('settingsAccountActions');

            if (authenticated && account) {
                indicator.classList.add('authenticated');
                const displayEmail = account.email || account.account_slug || 'Authenticated';
                text.innerHTML = `<span class="auth-email">${displayEmail}</span>`;
                button.textContent = 'Logout';
                button.onclick = performLogout;

                // Update settings modal auth status
                if (settingsAuthStatus) {
                    settingsAuthStatus.textContent = displayEmail;
                    settingsAuthStatus.style.color = '#28a745';
                }
                if (settingsAuthType && account.auth_type) {
                    const authTypeLabel = account.auth_type === 'authorization_code' ? '(SSO)' : '(Service Account)';
                    settingsAuthType.textContent = authTypeLabel;
                }
                if (settingsAccountActions) {
                    settingsAccountActions.style.display = 'flex';
                }

                // Update validation section
                document.getElementById('validationAuthRequired').style.display = 'none';
                document.getElementById('validationAuthReady').style.display = 'block';

                // Update learning section
                document.getElementById('learnAuthRequired').style.display = 'none';
                document.getElementById('learnAuthReady').style.display = 'block';
                document.getElementById('uploadAuthRequired').style.display = 'none';
                document.getElementById('uploadAuthReady').style.display = 'block';
            } else {
                indicator.classList.remove('authenticated');
                text.textContent = 'Not authenticated';
                button.textContent = 'Login';
                button.onclick = showLogin;

                // Update settings modal auth status
                if (settingsAuthStatus) {
                    settingsAuthStatus.textContent = 'Not authenticated';
                    settingsAuthStatus.style.color = '';
                }
                if (settingsAuthType) {
                    settingsAuthType.textContent = '';
                }
                if (settingsAccountActions) {
                    settingsAccountActions.style.display = 'none';
                }

                // Update validation section
                document.getElementById('validationAuthRequired').style.display = 'block';
                document.getElementById('validationAuthReady').style.display = 'none';

                // Update learning section
                document.getElementById('learnAuthRequired').style.display = 'block';
                document.getElementById('learnAuthReady').style.display = 'none';
                document.getElementById('uploadAuthRequired').style.display = 'block';
                document.getElementById('uploadAuthReady').style.display = 'none';
            }
        }

        function showLogin() {
            document.getElementById('loginModal').classList.add('show');
        }

        function closeLogin() {
            document.getElementById('loginModal').classList.remove('show');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        async function performLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('error', 'Please enter both email and password');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    updateAuthUI(true, data.account);
                    closeLogin();
                    showAlert('success', 'Successfully logged in!');
                } else {
                    showAlert('error', data.error || 'Login failed');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            }
        }

        async function performLogout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });

                if (response.ok) {
                    updateAuthUI(false);
                    showAlert('success', 'Successfully logged out');
                } else {
                    showAlert('error', 'Logout failed');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            }
        }

        async function refreshAccount() {
            try {
                const response = await fetch('/api/auth/refresh-account', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    updateAuthUI(true, data.account);
                    showAlert('success', 'Account refreshed: ' + (data.account.account_slug || data.account.email));
                } else {
                    showAlert('error', data.error || 'Failed to refresh account');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            }
        }

        // Settings Modal Functions
        let aiSettings = {
            enabled: false,
            provider: 'openai',
            apiKey: '',
            maxIterations: 4
        };

        // Load settings on page load
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings/ai');
                if (response.ok) {
                    const data = await response.json();
                    aiSettings.enabled = data.enabled;
                    aiSettings.provider = data.provider;
                    aiSettings.maxIterations = data.max_iterations;
                    // Note: API key is not returned for security, but we know if one exists
                    if (data.has_api_key) {
                        aiSettings.apiKey = '***saved***';  // Placeholder
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Call on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
        });

        function showSettings() {
            // Load current settings
            document.getElementById('enableAI').checked = aiSettings.enabled;
            document.getElementById('aiProvider').value = aiSettings.provider;
            document.getElementById('maxIterations').value = aiSettings.maxIterations;

            // Update auth status
            const authStatus = document.getElementById('settingsAuthStatus');
            if (isAuthenticated) {
                authStatus.textContent = '‚úì Authenticated';
                authStatus.style.color = '#28a745';
            } else {
                authStatus.textContent = 'Not authenticated';
                authStatus.style.color = '#999';
            }

            // Update API key sections
            updateApiKeyStatus();

            // Toggle AI settings visibility
            toggleAISettings();

            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        // Debug Console Functions
        let debugConsoleVisible = false;

        async function toggleDebugConsole() {
            debugConsoleVisible = !debugConsoleVisible;
            const display = document.getElementById('debugConsoleDisplay');
            const toggleBtn = document.getElementById('debugConsoleToggle');

            if (debugConsoleVisible) {
                display.style.display = 'block';
                toggleBtn.textContent = 'Hide API Logs';
                await refreshDebugLogs();
            } else {
                display.style.display = 'none';
                toggleBtn.textContent = 'Show API Logs';
            }
        }

        async function refreshDebugLogs() {
            const logsContent = document.getElementById('debugLogsContent');
            const logCount = document.getElementById('debugLogCount');

            try {
                logsContent.innerHTML = '<div style="color: #999;">Loading logs...</div>';

                const response = await fetch('/api/debug/logs');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    logsContent.innerHTML = '<div style="color: #f44336;">Error loading logs: ' + (data.error || 'Unknown error') + '</div>';
                    return;
                }

                const logs = data.logs || [];
                logCount.textContent = logs.length + ' log' + (logs.length !== 1 ? 's' : '');

                if (logs.length === 0) {
                    logsContent.innerHTML = '<div style="color: #999;">No API logs yet. Try uploading a template or generating a document.</div>';
                    return;
                }

                // Format logs as HTML
                let html = '';
                logs.forEach((log, index) => {
                    const timestamp = new Date(log.timestamp).toLocaleTimeString();
                    const statusColor = log.response_status >= 200 && log.response_status < 300 ? '#4caf50' :
                                      log.response_status >= 400 ? '#f44336' : '#ff9800';

                    html += `
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #569cd6; font-weight: bold;">${log.method}</span>
                                <span style="color: #999; font-size: 11px;">${timestamp}</span>
                            </div>
                            <div style="color: #ce9178; margin-bottom: 4px; word-break: break-all;">${log.url}</div>
                            ${log.response_status ? `<div style="color: ${statusColor}; margin-bottom: 4px;">Status: ${log.response_status}</div>` : ''}
                            ${log.payload ? `
                                <div style="margin-top: 8px;">
                                    <div style="color: #999; font-size: 11px; margin-bottom: 4px;">Payload:</div>
                                    <pre style="margin: 0; padding: 8px; background: #252526; border-radius: 4px; overflow-x: auto; font-size: 11px; color: #d4d4d4;">${JSON.stringify(log.payload, null, 2)}</pre>
                                </div>
                            ` : ''}
                            ${log.response_body ? `
                                <div style="margin-top: 8px;">
                                    <div style="color: #999; font-size: 11px; margin-bottom: 4px;">Response:</div>
                                    <pre style="margin: 0; padding: 8px; background: #252526; border-radius: 4px; overflow-x: auto; font-size: 11px; color: #d4d4d4; max-height: 200px;">${log.response_body}</pre>
                                </div>
                            ` : ''}
                            ${log.error ? `<div style="color: #f44336; margin-top: 4px;">Error: ${log.error}</div>` : ''}
                        </div>
                    `;
                });

                logsContent.innerHTML = html;

            } catch (error) {
                logsContent.innerHTML = '<div style="color: #f44336;">Error: ' + error.message + '</div>';
            }
        }

        async function clearDebugLogs() {
            if (!confirm('Clear all API logs?')) {
                return;
            }

            try {
                const response = await fetch('/api/debug/logs/clear', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('success', 'Debug logs cleared');
                    if (debugConsoleVisible) {
                        await refreshDebugLogs();
                    }
                } else {
                    showAlert('error', 'Failed to clear logs: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            }
        }

        function toggleAISettings() {
            const enabled = document.getElementById('enableAI').checked;
            const aiProviderSettings = document.getElementById('aiProviderSettings');
            const learningStatsSection = document.getElementById('learningStatsSection');

            aiProviderSettings.style.display = enabled ? 'block' : 'none';
            learningStatsSection.style.display = enabled ? 'block' : 'none';

            if (enabled) {
                updateApiKeyStatus();
                refreshLearningStats();
            }
        }

        function updateApiKeyStatus() {
            const provider = document.getElementById('aiProvider').value;
            const hasKey = aiSettings.apiKey === '***saved***';

            const inputSection = document.getElementById('apiKeyInputSection');
            const statusSection = document.getElementById('apiKeyStatusSection');
            const providerName = document.getElementById('apiKeyProviderName');

            if (hasKey) {
                inputSection.style.display = 'none';
                statusSection.style.display = 'block';
                providerName.textContent = provider === 'openai' ? 'OpenAI' : 'Anthropic';
            } else {
                inputSection.style.display = 'block';
                statusSection.style.display = 'none';
            }
        }

        function changeApiKey() {
            // Show the input section to enter new key
            document.getElementById('apiKeyInputSection').style.display = 'block';
            document.getElementById('apiKeyStatusSection').style.display = 'none';
            document.getElementById('aiApiKey').value = '';
            document.getElementById('aiApiKey').focus();
        }

        async function saveApiKey() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value.trim();

            if (!apiKey) {
                showAlert('error', 'Please enter an API key');
                return;
            }

            const saveBtn = document.getElementById('saveApiKeyBtn');

            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Validating...';

                // Validate the key
                const response = await fetch('/api/settings/ai/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, api_key: apiKey })
                });

                const data = await response.json();

                if (!response.ok || !data.valid) {
                    showAlert('error', data.error || 'Invalid API key');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Key';
                    return;
                }

                // Save to server
                saveBtn.textContent = 'Saving...';

                const saveResponse = await fetch('/api/settings/ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: document.getElementById('enableAI').checked,
                        provider: provider,
                        apiKey: apiKey,
                        maxIterations: parseInt(document.getElementById('maxIterations').value)
                    })
                });

                if (saveResponse.ok) {
                    showAlert('success', `‚úì ${provider === 'openai' ? 'OpenAI' : 'Anthropic'} API key saved successfully`);

                    // Update local state
                    aiSettings.apiKey = '***saved***';
                    aiSettings.provider = provider;

                    // Clear input and show status
                    document.getElementById('aiApiKey').value = '';
                    updateApiKeyStatus();
                } else {
                    const saveData = await saveResponse.json();
                    showAlert('error', saveData.error || 'Failed to save key');
                }

            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Key';
            }
        }

        // Note: saveSettings() removed - now using saveApiKey() with separate button

        // Upload area handlers
        const uploadArea = document.getElementById('uploadArea');
        async function refreshLearningStats() {
            const statsContent = document.getElementById('learningStatsContent');

            try {
                statsContent.textContent = 'Loading...';

                const response = await fetch('/api/learning-stats');
                const data = await response.json();

                if (response.ok && data.success) {
                    const stats = data.stats;

                    let html = '';
                    html += `<div style="margin-bottom: 8px;"><strong>Total Learned:</strong></div>`;
                    html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">`;
                    html += `  <div>‚Ä¢ Field Mappings: ${stats.total_field_mappings}</div>`;
                    html += `  <div>‚Ä¢ Syntax Fixes: ${stats.total_syntax_fixes}</div>`;
                    html += `  <div>‚Ä¢ Iterations: ${stats.total_iterations_recorded}</div>`;
                    html += `</div>`;

                    if (stats.most_common_mappings && stats.most_common_mappings.length > 0) {
                        html += `<div style="margin-top: 8px;"><strong>Top Mappings:</strong></div>`;
                        html += `<div style="font-size: 11px; max-height: 100px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px; margin-top: 4px;">`;
                        stats.most_common_mappings.slice(0, 5).forEach(m => {
                            html += `<div style="margin: 2px 0;">‚Ä¢ ${m.v1_field} ‚Üí ${m.v2_field} (${m.count}x)</div>`;
                        });
                        html += `</div>`;
                    }

                    if (stats.most_common_fixes && stats.most_common_fixes.length > 0) {
                        html += `<div style="margin-top: 8px;"><strong>Top Fixes:</strong></div>`;
                        html += `<div style="font-size: 11px; max-height: 100px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px; margin-top: 4px;">`;
                        stats.most_common_fixes.slice(0, 5).forEach(f => {
                            html += `<div style="margin: 2px 0;">‚Ä¢ ${f.error_pattern.substring(0, 50)} (${f.count}x)</div>`;
                        });
                        html += `</div>`;
                    }

                    statsContent.innerHTML = html;
                } else {
                    statsContent.textContent = 'Failed to load statistics';
                }
            } catch (error) {
                statsContent.textContent = `Error: ${error.message}`;
            }
        }

        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function showAlert(type, message) {
            // Route all alerts to the bottom status bar
            if (type === 'error') {
                showStatus('Error', message);
                // Auto-hide after 5 seconds for errors
                setTimeout(() => hideStatus(), 5000);
            } else if (type === 'success') {
                showStatus(message, '');
                // Auto-hide after 3 seconds for success
                setTimeout(() => hideStatus(), 3000);
            } else if (type === 'warning') {
                showStatus('Warning', message);
                setTimeout(() => hideStatus(), 5000);
            }
        }

        function showModal(title, content) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            // Create modal container
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 8px;
                max-width: 800px;
                max-height: 80vh;
                overflow: auto;
                padding: 24px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;

            // Add header with close button
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                border-bottom: 1px solid #ddd;
                padding-bottom: 12px;
            `;

            const titleEl = document.createElement('h2');
            titleEl.textContent = title;
            titleEl.style.margin = '0';

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.style.cssText = `
                background: none;
                border: none;
                font-size: 32px;
                cursor: pointer;
                color: #666;
                padding: 0;
                width: 32px;
                height: 32px;
                line-height: 32px;
            `;
            closeBtn.onclick = () => overlay.remove();

            header.appendChild(titleEl);
            header.appendChild(closeBtn);

            // Add content
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = content;

            modal.appendChild(header);
            modal.appendChild(contentDiv);
            overlay.appendChild(modal);

            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            };

            document.body.appendChild(overlay);
        }

        function showStatus(message, detail = '') {
            const statusBar = document.getElementById('statusBar');
            const statusMessage = document.getElementById('statusMessage');
            const statusDetail = document.getElementById('statusDetail');
            const statusSpinner = document.getElementById('statusSpinner');

            statusMessage.textContent = message;
            statusDetail.textContent = detail;
            statusSpinner.style.display = 'block';
            statusBar.classList.add('visible');
        }

        function updateStatus(message, detail = '') {
            const statusMessage = document.getElementById('statusMessage');
            const statusDetail = document.getElementById('statusDetail');

            statusMessage.textContent = message;
            statusDetail.textContent = detail;
        }

        function hideStatus() {
            const statusBar = document.getElementById('statusBar');
            const statusSpinner = document.getElementById('statusSpinner');

            statusSpinner.style.display = 'none';
            statusBar.classList.remove('visible');
        }

        function showProgress() {
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressBar').style.width = '50%';
        }

        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
        }

        async function handleFile(file) {
            if (!file.name.endsWith('.docx')) {
                showAlert('error', 'Please upload a .docx file');
                return;
            }

            showProgress();

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    uploadedFile = file.name;
                    analysisData = data.analysis;
                    displayAnalysis(data.analysis);
                    showAlert('success', `File "${data.filename}" uploaded and analyzed successfully!`);
                } else {
                    showAlert('error', data.error || 'Upload failed');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        function displayAnalysis(analysis) {
            document.getElementById('totalFields').textContent = analysis.total_fields;
            document.getElementById('simpleFields').textContent = analysis.simple_fields;
            document.getElementById('loopFields').textContent = analysis.loop_fields;
            document.getElementById('conditionalFields').textContent = analysis.conditional_fields;

            // Display simple fields
            const simpleList = document.getElementById('simpleFieldsList');
            simpleList.innerHTML = '<h3>Simple Fields</h3>';
            analysis.simple_fields_list.forEach(field => {
                const div = document.createElement('div');
                div.className = 'field-item';
                div.textContent = field;
                simpleList.appendChild(div);
            });

            // Display loop fields
            const loopList = document.getElementById('loopFieldsList');
            loopList.innerHTML = '<h3>Loop Fields</h3>';
            analysis.loop_fields_list.forEach(field => {
                const div = document.createElement('div');
                div.className = 'field-item';
                div.textContent = field;
                loopList.appendChild(div);
            });

            // Display conditional fields
            const conditionalList = document.getElementById('conditionalFieldsList');
            conditionalList.innerHTML = '<h3>Conditional Fields</h3>';
            analysis.conditional_fields_list.forEach(field => {
                const div = document.createElement('div');
                div.className = 'field-item';
                div.textContent = field;
                conditionalList.appendChild(div);
            });

            document.getElementById('analysisResults').style.display = 'block';
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        async function convertTemplate() {
            const btn = document.getElementById('convertBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Converting...';

            try {
                const response = await fetch('/api/convert', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    // Check validation results
                    if (data.validation && data.validation.error_count > 0) {
                        showAlert('warning', `Template converted but has ${data.validation.error_count} validation error(s)`);

                        const warningsList = document.getElementById('warningsList');
                        warningsList.innerHTML = '<h3>‚ùå Template Validation Errors</h3>';
                        const errorDiv = document.createElement('div');
                        errorDiv.style.background = '#f8d7da';
                        errorDiv.style.padding = '16px';
                        errorDiv.style.borderRadius = '8px';
                        errorDiv.style.marginBottom = '16px';
                        data.validation.errors.forEach(error => {
                            const div = document.createElement('div');
                            div.style.padding = '4px 0';
                            div.textContent = '‚Ä¢ ' + error;
                            errorDiv.appendChild(div);
                        });
                        warningsList.appendChild(errorDiv);
                    } else {
                        showAlert('success', 'Template converted successfully!');
                    }

                    // Show conversion warnings
                    const warningCount = document.getElementById('warningCount');
                    if (data.warnings && data.warnings.length > 0) {
                        warningCount.textContent = `(${data.warnings.length} warnings - see below)`;

                        const warningsList = document.getElementById('warningsList');
                        if (!warningsList.innerHTML.includes('Conversion Warnings')) {
                            warningsList.innerHTML += '<h3>‚ö†Ô∏è Conversion Warnings</h3>';
                        }
                        const ul = document.createElement('div');
                        ul.style.background = '#fff3cd';
                        ul.style.padding = '16px';
                        ul.style.borderRadius = '8px';
                        data.warnings.forEach(warning => {
                            const div = document.createElement('div');
                            div.style.padding = '4px 0';
                            div.textContent = '‚Ä¢ ' + warning;
                            ul.appendChild(div);
                        });
                        warningsList.appendChild(ul);
                    }

                    // Show validation warnings
                    if (data.validation && data.validation.warning_count > 0) {
                        const warningsList = document.getElementById('warningsList');
                        if (!warningsList.innerHTML.includes('Validation Warnings')) {
                            warningsList.innerHTML += '<h3>‚ö†Ô∏è Template Validation Warnings</h3>';
                        }
                        const warnDiv = document.createElement('div');
                        warnDiv.style.background = '#fff3cd';
                        warnDiv.style.padding = '16px';
                        warnDiv.style.borderRadius = '8px';
                        data.validation.warnings.forEach(warning => {
                            const div = document.createElement('div');
                            div.style.padding = '4px 0';
                            div.textContent = '‚Ä¢ ' + warning;
                            warnDiv.appendChild(div);
                        });
                        warningsList.appendChild(warnDiv);
                    }

                    document.getElementById('downloadSection').classList.remove('hidden');
                    document.getElementById('downloadSection').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('error', data.error || 'Conversion failed');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Convert Template';
            }
        }

        function toggleValidation() {
            const section = document.getElementById('validationSection');
            section.style.display = section.style.display === 'none' || section.style.display === '' ? 'block' : 'none';
        }

        async function validateTemplate() {
            if (!isAuthenticated) {
                showAlert('error', 'Please login first to use validation');
                showLogin();
                return;
            }

            const projectId = document.getElementById('projectId').value;

            if (!projectId) {
                showAlert('error', 'Project ID is required');
                return;
            }

            const btn = document.getElementById('validateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Validating...';

            try {
                const response = await fetch('/api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: projectId })
                });

                const data = await response.json();

                if (response.ok) {
                    const validation = data.validation;

                    document.getElementById('validCount').textContent = validation.valid_count;
                    document.getElementById('missingCount').textContent = validation.missing_count;

                    const coverageFill = document.getElementById('coverageFill');
                    coverageFill.style.width = validation.coverage + '%';
                    coverageFill.textContent = validation.coverage + '%';

                    if (validation.missing_count > 0) {
                        const missingList = document.getElementById('missingFieldsList');
                        missingList.innerHTML = '<h4>Missing Fields:</h4>';
                        const container = document.createElement('div');
                        container.style.background = '#f8d7da';
                        container.style.padding = '12px';
                        container.style.borderRadius = '8px';
                        validation.missing_fields.forEach(field => {
                            const div = document.createElement('div');
                            div.style.padding = '2px 0';
                            div.textContent = '‚Ä¢ ' + field;
                            container.appendChild(div);
                        });
                        missingList.appendChild(container);
                    }

                    document.getElementById('validationResults').style.display = 'block';
                    showAlert('success', 'Validation complete!');
                } else {
                    showAlert('error', data.error || 'Validation failed');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Run Validation';
            }
        }

        function downloadTemplate() {
            window.location.href = '/api/download';
        }

        function reset() {
            fetch('/api/cleanup', { method: 'POST' });
            location.reload();
        }

        // Learning Mappings Functions
        let learnedMappingsData = null;

        function showLearningTab(tab) {
            // Update buttons
            const buttons = document.querySelectorAll('#learnMappingsSection .tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.getElementById('apiLearningTab').classList.remove('active');
            document.getElementById('uploadLearningTab').classList.remove('active');
            document.getElementById(tab + 'LearningTab').classList.add('active');
        }

        async function uploadForLearning() {
            if (!isAuthenticated) {
                showAlert('error', 'Please login first to use this feature');
                showLogin();
                return;
            }

            const projectId = document.getElementById('uploadProjectId').value;
            const v1Template = document.getElementById('v1TemplateFile').files[0];
            const outputDoc = document.getElementById('outputDocFile').files[0];
            const v2Template = document.getElementById('v2TemplateFile').files[0];

            if (!projectId) {
                showAlert('error', 'Project ID is required');
                return;
            }

            if (!v1Template || !outputDoc) {
                showAlert('error', 'Both v1 template and output document are required');
                return;
            }

            const btn = document.getElementById('uploadLearnBtn');
            const debugConsole = document.getElementById('debugConsole');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Uploading & Learning...';

            // Show debug console
            debugConsole.classList.add('show');
            debugConsole.innerHTML = '<div class="info">üì§ Uploading documents...</div>';

            try {
                const formData = new FormData();
                formData.append('project_id', projectId);
                formData.append('v1_template', v1Template);
                formData.append('output_doc', outputDoc);
                if (v2Template) {
                    formData.append('v2_template', v2Template);
                }

                const response = await fetch('/api/upload-for-learning', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Display debug log if available
                if (data.debug_log) {
                    debugConsole.innerHTML += `<div class="log-line">${data.debug_log}</div>`;
                }

                if (data.traceback) {
                    debugConsole.innerHTML += `<div class="error">Traceback:\n${data.traceback}</div>`;
                }

                if (response.ok) {
                    debugConsole.innerHTML += '<div class="success">‚úì Learning complete!</div>';
                    debugConsole.innerHTML += `<div class="success">Discovered ${data.mappings_discovered} total mappings:</div>`;
                    debugConsole.innerHTML += `<div class="info">  ‚Ä¢ ${data.confirmed_mappings} confirmed from document analysis</div>`;
                    debugConsole.innerHTML += `<div class="info">  ‚Ä¢ ${data.supplemental_mappings} supplemental from value matching</div>`;

                    // Show sample mappings
                    if (data.sample_mappings && data.sample_mappings.length > 0) {
                        debugConsole.innerHTML += '<div class="info" style="margin-top: 10px;"><strong>Sample Mappings:</strong></div>';
                        data.sample_mappings.forEach(mapping => {
                            const icon = mapping.confirmed_in_output ? '‚úì' : '‚Ä¢';
                            const confidence = mapping.confidence === 'high' ? 'üü¢' : 'üü°';
                            debugConsole.innerHTML += `<div class="log-line" style="padding-left: 20px;">${icon} ${confidence} ${mapping.v1_field} ‚Üí ${mapping.v2_field}</div>`;
                        });
                    }

                    // Show database stats
                    const stats = data.database_stats;
                    document.getElementById('dbTotalMappings').textContent = stats.total_mappings;
                    document.getElementById('dbHighConf').textContent = stats.high_confidence;
                    document.getElementById('dbVeryHighConf').textContent = stats.very_high_confidence;
                    document.getElementById('dbProjectsCount').textContent = stats.projects_analyzed;
                    document.getElementById('databaseStats').style.display = 'block';

                    showAlert('success', `Learned ${data.mappings_discovered} mappings (${data.confirmed_mappings} confirmed)! Database now has ${stats.total_mappings} total.`);

                    // Clear file inputs
                    document.getElementById('v1TemplateFile').value = '';
                    document.getElementById('outputDocFile').value = '';
                    document.getElementById('v2TemplateFile').value = '';
                } else {
                    debugConsole.innerHTML += `<div class="error">‚ùå Error: ${data.error}</div>`;
                    showAlert('error', data.error || 'Upload failed');
                }
            } catch (error) {
                debugConsole.innerHTML += `<div class="error">‚ùå Network error: ${error.message}</div>`;
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üì§ Upload & Learn Mappings';
            }
        }

        async function testProject() {
            if (!isAuthenticated) {
                showAlert('error', 'Please login first to use this feature');
                showLogin();
                return;
            }

            const projectId = document.getElementById('learnProjectId').value;

            if (!projectId) {
                showAlert('error', 'Project ID is required');
                return;
            }

            const btn = document.getElementById('testProjectBtn');
            const debugConsole = document.getElementById('debugConsole');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testing...';

            // Show and initialize debug console
            debugConsole.classList.add('show');
            debugConsole.innerHTML = '<div class="info">üß™ Testing project ' + projectId + '...</div>';

            try {
                const response = await fetch('/api/test-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: projectId })
                });

                const data = await response.json();

                if (response.ok) {
                    // Display v1 status
                    if (data.v1_status === 'success') {
                        debugConsole.innerHTML += '<div class="success">‚úì v1 merge data: ACCESSIBLE</div>';
                    } else {
                        debugConsole.innerHTML += '<div class="error">‚úó v1 merge data: FAILED</div>';
                        if (data.v1_error) {
                            debugConsole.innerHTML += '<div class="error">  Error: ' + data.v1_error + '</div>';
                        }
                    }

                    // Display v2 status
                    if (data.v2_status === 'success') {
                        debugConsole.innerHTML += '<div class="success">‚úì v2 merge data: ACCESSIBLE</div>';
                    } else {
                        debugConsole.innerHTML += '<div class="error">‚úó v2 merge data: FAILED</div>';
                        if (data.v2_error) {
                            debugConsole.innerHTML += '<div class="error">  Error: ' + data.v2_error + '</div>';
                        }
                    }

                    // Overall status
                    if (data.ready) {
                        debugConsole.innerHTML += '<div class="success">‚úì Project is ready for mapping discovery!</div>';
                        showAlert('success', 'Project is ready! Click "Discover Mappings" to proceed.');
                    } else {
                        debugConsole.innerHTML += '<div class="error">‚ùå Project has issues - try a different project ID</div>';
                        showAlert('warning', 'Project has issues accessing merge data. Try a different project ID.');
                    }
                } else {
                    debugConsole.innerHTML += `<div class="error">‚ùå Error: ${data.error}</div>`;
                    showAlert('error', data.error || 'Test failed');
                }
            } catch (error) {
                debugConsole.innerHTML += `<div class="error">‚ùå Network error: ${error.message}</div>`;
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üß™ Test Project';
            }
        }

        async function learnMappings() {
            if (!isAuthenticated) {
                showAlert('error', 'Please login first to use this feature');
                showLogin();
                return;
            }

            const projectId = document.getElementById('learnProjectId').value;

            if (!projectId) {
                showAlert('error', 'Project ID is required');
                return;
            }

            const btn = document.getElementById('learnMappingsBtn');
            const debugConsole = document.getElementById('debugConsole');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Learning Mappings...';

            // Show and initialize debug console
            debugConsole.classList.add('show');
            debugConsole.innerHTML = '<div class="info">üîç Starting mapping discovery...</div>';

            try {
                const response = await fetch('/api/learn-mappings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: projectId })
                });

                const data = await response.json();

                // Display debug log if available
                if (data.debug_log) {
                    debugConsole.innerHTML += `<div class="log-line">${data.debug_log}</div>`;
                }

                if (data.traceback) {
                    debugConsole.innerHTML += `<div class="error">Traceback:\n${data.traceback}</div>`;
                }

                if (response.ok) {
                    learnedMappingsData = data;
                    displayLearningResults(data);
                    debugConsole.innerHTML += '<div class="success">‚úì Mapping discovery complete!</div>';
                    showAlert('success', `Discovered ${data.stats.total_mappings} field mappings!`);

                    // Scroll debug console to bottom
                    debugConsole.scrollTop = debugConsole.scrollHeight;
                } else {
                    debugConsole.innerHTML += `<div class="error">‚ùå Error: ${data.error}</div>`;
                    showAlert('error', data.error || 'Learning failed');
                }
            } catch (error) {
                debugConsole.innerHTML += `<div class="error">‚ùå Network error: ${error.message}</div>`;
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Discover Mappings';
            }
        }

        function displayLearningResults(data) {
            // Update stats
            document.getElementById('highConfCount').textContent = data.stats.high_confidence;
            document.getElementById('mediumConfCount').textContent = data.stats.medium_confidence;
            document.getElementById('lowConfCount').textContent = data.stats.low_confidence;

            // Display high confidence mappings
            displayMappingList('high', data.mappings.high);

            // Display medium confidence mappings
            displayMappingList('medium', data.mappings.medium);

            // Display low confidence mappings
            displayMappingList('low', data.mappings.low);

            // Show results section
            document.getElementById('learningResults').style.display = 'block';
        }

        function displayMappingList(confidence, mappings) {
            const listElement = document.getElementById(`${confidence}MappingsList`);
            listElement.innerHTML = `<h3>${confidence.charAt(0).toUpperCase() + confidence.slice(1)} Confidence Mappings</h3>`;

            if (mappings.length === 0) {
                listElement.innerHTML += '<p style="color: #666; padding: 20px; text-align: center;">No mappings found</p>';
                return;
            }

            mappings.forEach((mapping, index) => {
                const div = document.createElement('div');
                div.className = 'mapping-item';

                const header = document.createElement('div');
                header.className = 'mapping-header';

                const v1Field = document.createElement('span');
                v1Field.className = 'v1-field';
                v1Field.textContent = `=${mapping.v1_field}`;

                const arrow = document.createElement('span');
                arrow.className = 'arrow';
                arrow.textContent = '‚Üí';

                const v2Field = document.createElement('span');
                v2Field.className = 'v2-field';
                v2Field.textContent = `{${mapping.v2_field}}`;

                header.appendChild(v1Field);
                header.appendChild(arrow);
                header.appendChild(v2Field);

                div.appendChild(header);

                // Add sample value
                const sampleValue = document.createElement('div');
                sampleValue.className = 'sample-value';
                let displayValue = mapping.value;
                if (typeof displayValue === 'string' && displayValue.length > 100) {
                    displayValue = displayValue.substring(0, 97) + '...';
                }
                sampleValue.textContent = `Sample value: ${displayValue}`;
                div.appendChild(sampleValue);

                // Add badge
                const badge = document.createElement('span');
                badge.className = `confidence-badge ${confidence}`;
                badge.textContent = confidence;
                div.appendChild(badge);

                // Show alternative paths if available
                if (mapping.v2_paths && mapping.v2_paths.length > 1) {
                    const alternatives = document.createElement('div');
                    alternatives.style.fontSize = '11px';
                    alternatives.style.color = '#999';
                    alternatives.style.marginTop = '8px';
                    alternatives.textContent = `${mapping.v2_paths.length} alternative v2 paths available`;
                    div.appendChild(alternatives);
                }

                listElement.appendChild(div);
            });
        }

        function showMappingTab(tab) {
            // Update buttons
            const buttons = document.querySelectorAll('#learningResults .tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.getElementById('highMappingsTab').classList.remove('active');
            document.getElementById('mediumMappingsTab').classList.remove('active');
            document.getElementById('lowMappingsTab').classList.remove('active');
            document.getElementById(tab + 'MappingsTab').classList.add('active');
        }

        function exportMappings() {
            if (!learnedMappingsData) {
                showAlert('error', 'No mappings to export');
                return;
            }

            const dataStr = JSON.stringify(learnedMappingsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `learned_mappings_${learnedMappingsData.project_id}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showAlert('success', 'Mappings exported successfully!');
        }

        // Template Workflow Functions
        let templateListData = null;

        async function loadTemplateList() {
            if (!isAuthenticated) {
                showAlert('error', 'Please login first');
                showLogin();
                return;
            }

            const btn = document.getElementById('loadTemplatesBtn');
            const select = document.getElementById('templateSelect');
            const activeOnly = document.getElementById('activeOnlyFilter').checked;

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Loading...';

            try {
                const response = await fetch(`/api/templates/list?active_only=${activeOnly}`);
                const data = await response.json();

                if (response.ok) {
                    templateListData = data.templates;

                    // Clear and populate select
                    select.innerHTML = '';

                    if (templateListData.length === 0) {
                        select.innerHTML = '<option value="">No templates found</option>';
                    } else {
                        // Filter for v1 templates only
                        const v1Templates = templateListData.filter(t =>
                            t.attributes['template-format'] === 'v1'
                        );

                        if (v1Templates.length === 0) {
                            select.innerHTML = '<option value="">No v1 templates found</option>';
                        } else {
                            v1Templates.forEach(template => {
                                const option = document.createElement('option');
                                option.value = template.id;
                                const active = template.attributes.active ? '‚úì' : ' ';
                                option.textContent = `[${active}] ${template.attributes.name} (ID: ${template.id})`;
                                option.dataset.template = JSON.stringify(template);
                                select.appendChild(option);
                            });

                            showAlert('success', `Loaded ${v1Templates.length} v1 templates`);
                        }
                    }
                } else {
                    showAlert('error', data.error || 'Failed to load templates');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìã Load Templates';
            }
        }

        // Show template details when selected
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('templateSelect');
            if (select) {
                select.addEventListener('change', (e) => {
                    const option = e.target.selectedOptions[0];
                    if (option && option.dataset.template) {
                        const template = JSON.parse(option.dataset.template);
                        document.getElementById('detailName').textContent = template.attributes.name;
                        document.getElementById('detailId').textContent = template.id;
                        document.getElementById('detailFormat').textContent = template.attributes['template-format'];
                        document.getElementById('detailFilename').textContent = template.attributes['merge-template-filename'];
                        document.getElementById('templateDetails').style.display = 'block';
                    }
                });
            }
        });

        async function runCompleteWorkflow() {
            if (!isAuthenticated) {
                showAlert('error', 'Please login first');
                showLogin();
                return;
            }

            const select = document.getElementById('templateSelect');
            const v1TemplateId = select.value;
            const projectId = document.getElementById('workflowProjectId').value;
            const newTemplateName = document.getElementById('newTemplateName').value;

            if (!v1TemplateId) {
                showAlert('error', 'Please select a v1 template');
                return;
            }

            if (!projectId) {
                showAlert('error', 'Please enter a project ID');
                return;
            }

            if (!newTemplateName) {
                showAlert('error', 'Please enter a name for the new template');
                return;
            }

            const btn = document.getElementById('workflowBtn');
            const debugConsole = document.getElementById('workflowDebugConsole');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running Workflow...';

            // Show debug console
            debugConsole.classList.add('show');
            debugConsole.innerHTML = '<div class="info">üöÄ Starting complete workflow...</div>';

            try {
                const response = await fetch('/api/templates/convert-and-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        v1_template_id: v1TemplateId,
                        project_id: projectId,
                        new_template_name: newTemplateName
                    })
                });

                const data = await response.json();

                // Display debug log
                if (data.debug_log) {
                    debugConsole.innerHTML += `<div class="log-line">${data.debug_log}</div>`;
                }

                if (data.traceback) {
                    debugConsole.innerHTML += `<div class="error">Traceback:\n${data.traceback}</div>`;
                }

                if (response.ok) {
                    debugConsole.innerHTML += '<div class="success">‚úÖ Workflow completed successfully!</div>';

                    // Show results
                    document.getElementById('resultV1Id').textContent = data.v1_template_id;
                    document.getElementById('resultV2Id').textContent = data.new_template_id;
                    document.getElementById('resultV2IdCopy').textContent = data.new_template_id;
                    document.getElementById('resultName').textContent = data.new_template_name;
                    document.getElementById('resultMappings').textContent = data.mappings_learned;
                    document.getElementById('workflowResults').style.display = 'block';

                    showAlert('success', `Template converted and uploaded! New template ID: ${data.new_template_id}`);

                    // Scroll to results
                    document.getElementById('workflowResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    debugConsole.innerHTML += `<div class="error">‚ùå Error: ${data.error}</div>`;
                    showAlert('error', data.error || 'Workflow failed');
                }
            } catch (error) {
                debugConsole.innerHTML += `<div class="error">‚ùå Network error: ${error.message}</div>`;
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Run Complete Workflow';

                // Scroll debug console to bottom
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
        }

        // ============================================================================
        // Unified Conversion Workflow Functions
        // ============================================================================

        let conversionState = {
            step: 1,
            inputMethod: null,
            templatePath: null,
            templateId: null,
            templateName: null,
            projectId: null,
            suggestedMappings: [],
            overrides: {},
            convertedFilePath: null,
            v2TemplateId: null,
            sessionId: null
        };

        // Step 1: Input Method Selection
        async function selectInputMethod(method) {
            conversionState.inputMethod = method;

            // Hide the workflow header (progressive flow) - workflow selector already removed
            // No need to hide workflowSelector anymore since it's been removed
            document.getElementById('convertWorkflowHeader').style.display = 'none';
            document.getElementById('inputMethodSelection').style.display = 'none';

            // Show the appropriate interface
            if (method === 'upload') {
                document.getElementById('uploadInterface').style.display = 'block';
                document.getElementById('platformInterface').style.display = 'none';
            } else {
                document.getElementById('uploadInterface').style.display = 'none';
                document.getElementById('platformInterface').style.display = 'block';

                // Auto-load templates if authenticated
                const authResponse = await fetch('/api/auth/status');
                const authData = await authResponse.json();

                if (authData.authenticated) {
                    // Automatically load v1 templates
                    await loadTemplateListForConversion();
                } else {
                    showAlert('warning', 'Please authenticate first to load templates from the platform.');
                    // TODO: Could trigger OAuth flow here
                }
            }
        }

        // Handle file upload in conversion workflow
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        await handleConversionFileUpload(file);
                    }
                });
            }

            // Handle v1 checkbox filter changes
            const v1Filter = document.getElementById('activeOnlyConvertFilter');
            if (v1Filter) {
                v1Filter.addEventListener('change', async () => {
                    const isChecked = v1Filter.checked;
                    showStatus(
                        isChecked ? 'Showing v1 templates only' : 'Showing all templates',
                        'Refreshing list...'
                    );
                    await loadTemplateListForConversion();
                    setTimeout(() => hideStatus(), 2000);
                });
            }
        });

        async function handleConversionFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showProgress('Uploading template...');

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    conversionState.templatePath = data.file_path;
                    hideProgress();
                    proceedToLearningStep();
                } else {
                    showAlert('error', data.error || 'Upload failed');
                    hideProgress();
                }
            } catch (error) {
                showAlert('error', 'Upload error: ' + error.message);
                hideProgress();
            }
        }

        let selectedTemplateId = null;

        async function loadTemplateListForConversion() {
            if (!isAuthenticated) {
                showStatus('Please login first', 'Authentication required');
                showLogin();
                return;
            }

            const tbody = document.getElementById('templateTableBody');
            const activeOnly = document.getElementById('activeTemplatesFilter')?.checked ?? true;

            showStatus('Loading templates from platform...', 'Fetching template list');

            try {
                const response = await fetch(`/api/templates/list?active_only=${activeOnly}`);
                const data = await response.json();

                if (response.ok) {
                    const v1Only = document.getElementById('activeOnlyConvertFilter').checked;
                    const templates = v1Only
                        ? data.templates.filter(t => t.attributes['template-format'] === 'v1')
                        : data.templates;

                    tbody.innerHTML = '';
                    templates.forEach(template => {
                        const row = document.createElement('tr');
                        row.style.cursor = 'pointer';
                        row.style.transition = 'background 0.2s';
                        row.dataset.templateId = template.id;
                        row.dataset.template = JSON.stringify(template);

                        // Get format and formatting values
                        const dataFormat = template.attributes['format'] || 'N/A';
                        const includeFormatting = template.attributes['include-formatting'];
                        let formattingDisplay = 'N/A';
                        let formattingColor = '#999';
                        if (includeFormatting === true) {
                            formattingDisplay = '‚úì Yes';
                            formattingColor = '#4caf50';
                        } else if (includeFormatting === false) {
                            formattingDisplay = '‚úó No';
                            formattingColor = '#999';
                        }

                        row.innerHTML = `
                            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">${template.attributes.name || 'Unnamed'}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                                <span style="background: ${template.attributes['template-format'] === 'v1' ? '#ffc107' : '#4caf50'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                    ${template.attributes['template-format'] || 'N/A'}
                                </span>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-family: monospace; font-size: 12px;">
                                ${dataFormat}
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: ${formattingColor};">
                                    ${formattingDisplay}
                                </span>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: ${template.attributes.active ? '#4caf50' : '#999'};">
                                    ${template.attributes.active ? '‚úì Yes' : '‚úó No'}
                                </span>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-family: monospace; font-size: 12px;">
                                ${template.attributes['merge-template-filename'] || 'N/A'}
                            </td>
                        `;

                        // Hover effect
                        row.addEventListener('mouseenter', () => {
                            row.style.background = '#f8f9fa';
                        });
                        row.addEventListener('mouseleave', () => {
                            if (row.dataset.templateId !== selectedTemplateId) {
                                row.style.background = 'white';
                            }
                        });

                        // Click to select
                        row.addEventListener('click', async () => {
                            // Deselect previous
                            document.querySelectorAll('#templateTableBody tr').forEach(r => {
                                r.style.background = 'white';
                                r.style.fontWeight = 'normal';
                            });

                            // Select this row
                            row.style.background = '#e3f2fd';
                            row.style.fontWeight = '500';
                            selectedTemplateId = template.id;

                            // Store template name
                            conversionState.templateName = template.attributes.name;

                            // Download template
                            await downloadTemplateForConversion(template.id);
                        });

                        tbody.appendChild(row);
                    });

                    hideStatus();
                } else {
                    hideStatus();
                    showStatus('Failed to load templates', data.error || 'Unknown error');
                }
            } catch (error) {
                hideStatus();
                showStatus('Network error', error.message);
            }
        }

        async function downloadTemplateForConversion(templateId) {
            try {
                showProgress('Downloading template from platform...');

                const response = await fetch(`/api/templates/${templateId}/download-for-conversion`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    conversionState.templatePath = data.path;
                    conversionState.templateId = templateId;
                    hideProgress();
                    proceedToLearningStep();
                } else {
                    showAlert('error', data.error || 'Download failed');
                    hideProgress();
                }
            } catch (error) {
                showAlert('error', 'Download error: ' + error.message);
                hideProgress();
            }
        }

        // Step 2: Learning
        async function proceedToLearningStep() {
            hideStep(1);
            showStep(2);

            // Auto-load projects if authenticated
            const authResponse = await fetch('/api/auth/status');
            const authData = await authResponse.json();

            if (authData.authenticated) {
                await loadRecentProjects();
            }
        }

        async function loadRecentProjects() {
            const btn = document.getElementById('loadProjectsBtn');
            const select = document.getElementById('convertProjectSelect');

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Loading...';
            }

            try {
                const response = await fetch('/api/projects/recent');
                const data = await response.json();

                if (response.ok) {
                    select.innerHTML = '<option value="">-- Select a project --</option>';
                    data.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.display;
                        select.appendChild(option);
                    });
                    showAlert('success', `Loaded ${data.projects.length} recent projects`);
                } else {
                    showAlert('error', data.error || 'Failed to load projects');
                }
            } catch (error) {
                showAlert('error', 'Network error: ' + error.message);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Load Projects';
                }
            }
        }

        async function proceedWithLearning() {
            const projectId = document.getElementById('convertProjectSelect').value;

            if (!projectId) {
                showAlert('error', 'Please select a project');
                return;
            }

            conversionState.projectId = projectId;

            // NEW INTEGRATED FLOW: Learn ‚Üí Convert ‚Üí Improve automatically
            try {
                showStatus('Learning mappings and starting conversion...', 'This will learn mappings, convert the template, and begin AI improvement automatically.');

                const response = await fetch('/api/learn-and-improve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_path: conversionState.templatePath,
                        project_id: projectId,
                        v1_template_id: conversionState.templateId  // Pass cloud template ID if selected
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Store session and template info
                    conversionState.sessionId = data.session_id;
                    conversionState.v2TemplateId = data.v2_template_id;
                    conversionState.learnedMappings = data.learned_mappings;

                    console.log('Integrated workflow started:', {
                        session: data.session_id,
                        template: data.v2_template_id,
                        mappings: data.learned_mappings.length
                    });

                    hideStatus();
                    showAlert('success', `Learned ${data.learned_mappings?.length || 0} mappings. Starting improvement...`);

                    // Move to Step 3: Show improvement progress
                    hideStep(2);
                    showStep(3);
                    startProgressPolling(data.session_id);
                } else {
                    hideStatus();
                    showAlert('error', data.error || 'Workflow failed');
                }
            } catch (error) {
                hideStatus();
                showAlert('error', 'Workflow error: ' + error.message);
            }
        }

        function startProgressPolling(sessionId) {
            /**
             * Poll the server for progress updates every 2 seconds
             * Updates the UI in real-time as the improvement process runs
             */
            const progressDisplay = document.getElementById('improvementProgress');
            const finalResults = document.getElementById('finalResults');

            if (!progressDisplay) {
                console.error('Progress display element not found');
                return;
            }

            // Show progress, hide results
            progressDisplay.style.display = 'block';
            if (finalResults) finalResults.style.display = 'none';

            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/improvement-progress/${sessionId}`);
                    const progress = await response.json();

                    if (progress.success) {
                        // Update progress display
                        updateProgressDisplay(progress);

                        // Check if complete or failed
                        if (progress.status === 'complete' || progress.status === 'failed') {
                            clearInterval(interval);
                            showFinalResults(progress);
                        }
                    } else {
                        console.error('Progress poll failed:', progress.error);
                    }
                } catch (error) {
                    console.error('Progress polling error:', error);
                }
            }, 2000);  // Poll every 2 seconds
        }

        function updateProgressDisplay(progress) {
            /**
             * Update the UI with current progress
             */
            // Update iteration count
            const iterationSpan = document.getElementById('currentIteration');
            if (iterationSpan) {
                iterationSpan.textContent = `Iteration ${progress.iteration || 0}/4`;
            }

            // Update similarity
            const similaritySpan = document.getElementById('currentSimilarity');
            if (similaritySpan) {
                const simPercent = (progress.similarity * 100).toFixed(1);
                similaritySpan.textContent = `Similarity: ${simPercent}%`;
            }

            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                const simPercent = (progress.similarity * 100).toFixed(1);
                progressFill.style.width = `${simPercent}%`;
            }

            // Add log message
            const iterationDetails = document.getElementById('iterationDetails');
            if (iterationDetails && progress.message) {
                const logEntry = document.createElement('div');
                logEntry.className = 'iteration-log';
                logEntry.innerHTML = `
                    <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    <span class="message">${progress.message}</span>
                `;
                iterationDetails.appendChild(logEntry);

                // Scroll to bottom
                iterationDetails.scrollTop = iterationDetails.scrollHeight;
            }
        }

        function showFinalResults(progress) {
            /**
             * Show final results when improvement completes
             */
            const progressDisplay = document.getElementById('improvementProgress');
            const finalResults = document.getElementById('finalResults');

            if (progressDisplay) progressDisplay.style.display = 'none';
            if (finalResults) {
                finalResults.style.display = 'block';

                // Update final similarity
                const finalSim = document.getElementById('finalSimilarity');
                if (finalSim) {
                    finalSim.textContent = `${(progress.similarity * 100).toFixed(1)}%`;

                    // Update success/failure message based on similarity
                    const successHeading = finalResults.querySelector('h3');
                    if (successHeading) {
                        if (progress.similarity >= 0.95) {
                            successHeading.textContent = 'Improvement Complete! üéâ';
                            successHeading.style.color = '#2e7d32';
                        } else {
                            successHeading.textContent = 'Improvement Completed with Issues ‚ö†Ô∏è';
                            successHeading.style.color = '#ff9800';
                        }
                    }

                    // Update similarity color
                    if (progress.similarity >= 0.95) {
                        finalSim.style.color = '#2e7d32';
                    } else if (progress.similarity >= 0.5) {
                        finalSim.style.color = '#ff9800';
                    } else {
                        finalSim.style.color = '#dc3545';
                    }
                }

                // Update total iterations
                const totalIter = document.getElementById('totalIterations');
                if (totalIter) {
                    totalIter.textContent = progress.total_iterations || progress.iteration || 0;
                }

                // Update final template ID display
                const finalTemplateId = document.getElementById('finalTemplateId');
                if (finalTemplateId && conversionState.v2TemplateId) {
                    finalTemplateId.textContent = conversionState.v2TemplateId;
                }

                // Store progress data for history view
                conversionState.improvementProgress = progress;

                if (progress.status === 'complete') {
                    if (progress.similarity >= 0.95) {
                        showAlert('success', 'Template improvement complete!');
                    } else {
                        showAlert('warning', `Improvement finished but similarity is only ${(progress.similarity * 100).toFixed(1)}%. You may need to review the template manually.`);
                    }
                } else {
                    showAlert('error', 'Improvement process encountered an error.');
                }
            }
        }

        async function viewConversionReport() {
            /**
             * Show detailed conversion report with V1/V2 data structures and mappings
             */
            const sessionId = conversionState.sessionId;
            if (!sessionId) {
                showAlert('warning', 'No session data available');
                return;
            }

            try {
                showProgress('Loading conversion report...');

                const response = await fetch(`/api/conversion-report/${sessionId}`);
                const report = await response.json();

                if (!response.ok) {
                    showAlert('error', report.error || 'Failed to load report');
                    hideProgress();
                    return;
                }

                hideProgress();

                // Build detailed HTML report
                let html = '<div style="max-height: 600px; overflow-y: auto;">';

                // V1 Template Info
                html += '<h3 style="color: #0066cc; margin-top: 0;">V1 Template</h3>';
                html += `<p><strong>Total Fields Found:</strong> ${report.v1_info.total_fields}</p>`;
                html += '<details><summary><strong>Field Structure</strong></summary><pre style="background: #f5f5f5; padding: 12px; overflow-x: auto; font-size: 12px;">';
                html += JSON.stringify(report.v1_info.structure, null, 2);
                html += '</pre></details>';

                if (report.v1_info.merge_data_sample) {
                    html += '<details><summary><strong>V1 Merge Data (sample)</strong></summary><pre style="background: #f5f5f5; padding: 12px; overflow-x: auto; font-size: 12px;">';
                    html += report.v1_info.merge_data_sample;
                    html += '</pre></details>';
                }

                // Learned Mappings
                html += '<h3 style="color: #0066cc; margin-top: 20px;">Learned Mappings</h3>';
                html += `<p><strong>Total Mappings:</strong> ${report.learned_mappings.length}</p>`;
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 12px;">';
                html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left; border: 1px solid #ddd;">V1 Field</th><th style="padding: 8px; text-align: left; border: 1px solid #ddd;">V2 Field</th><th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Type</th></tr>';
                report.learned_mappings.forEach(mapping => {
                    html += `<tr><td style="padding: 6px; border: 1px solid #ddd; font-family: monospace;">${mapping.v1_field || 'N/A'}</td>`;
                    html += `<td style="padding: 6px; border: 1px solid #ddd; font-family: monospace;">${mapping.v2_field || 'N/A'}</td>`;
                    html += `<td style="padding: 6px; border: 1px solid #ddd;">${mapping.mapping_type || 'field'}</td></tr>`;
                });
                html += '</table>';

                // V2 Template Info
                html += '<h3 style="color: #0066cc; margin-top: 20px;">V2 Template (Generated)</h3>';
                html += `<p><strong>Total Fields:</strong> ${report.v2_info.total_fields}</p>`;
                html += `<p><strong>Unique Fields:</strong> ${report.v2_info.unique_fields.length}</p>`;
                html += '<details><summary><strong>V2 Fields Found</strong></summary><pre style="background: #f5f5f5; padding: 12px; overflow-x: auto; font-size: 12px;">';
                html += report.v2_info.unique_fields.join('\n');
                html += '</pre></details>';

                if (report.v2_info.merge_data_sample) {
                    html += '<details><summary><strong>V2 Merge Data (sample)</strong></summary><pre style="background: #f5f5f5; padding: 12px; overflow-x: auto; font-size: 12px;">';
                    html += report.v2_info.merge_data_sample;
                    html += '</pre></details>';
                }

                // Loop Mappings
                if (report.loop_mappings && Object.keys(report.loop_mappings).length > 0) {
                    html += '<h3 style="color: #0066cc; margin-top: 20px;">Loop Mappings</h3>';
                    html += '<pre style="background: #f5f5f5; padding: 12px; overflow-x: auto; font-size: 12px;">';
                    html += JSON.stringify(report.loop_mappings, null, 2);
                    html += '</pre>';
                }

                // Current Status
                html += '<h3 style="color: #0066cc; margin-top: 20px;">Current Status</h3>';
                html += `<p><strong>Similarity:</strong> ${(report.current_similarity * 100).toFixed(1)}%</p>`;
                html += `<p><strong>Iterations Completed:</strong> ${report.iterations.length}</p>`;

                html += '</div>';

                showModal('Detailed Conversion Report', html);

            } catch (error) {
                console.error('Error loading conversion report:', error);
                showAlert('error', 'Failed to load conversion report');
                hideProgress();
            }
        }

        function viewIterationHistory() {
            /**
             * Show detailed iteration history in a modal
             */
            const progress = conversionState.improvementProgress;
            if (!progress || !progress.iterations) {
                showAlert('warning', 'No iteration history available');
                return;
            }

            let historyHTML = '<div style="max-height: 400px; overflow-y: auto;">';
            historyHTML += `<h3 style="margin-bottom: 16px;">Iteration History</h3>`;

            progress.iterations.forEach((iter, idx) => {
                const iterNum = iter.iteration || (idx + 1);
                const sim = ((iter.similarity || 0) * 100).toFixed(1);
                const statusColor = iter.status === 'success' ? '#28a745' :
                                  iter.status && iter.status.includes('fail') ? '#dc3545' : '#2196f3';

                historyHTML += `
                    <div style="border-left: 3px solid ${statusColor}; padding: 12px; margin-bottom: 12px; background: #f9f9f9; border-radius: 4px;">
                        <div style="font-weight: bold; margin-bottom: 4px;">Iteration ${iterNum}</div>
                        <div style="color: #666; font-size: 14px;">
                            Similarity: <strong style="color: ${statusColor};">${sim}%</strong><br>
                            Status: ${iter.status || 'unknown'}<br>
                            ${iter.syntax_errors !== undefined ? `Syntax Errors: ${iter.syntax_errors}<br>` : ''}
                            ${iter.fixes_applied !== undefined ? `Fixes Applied: ${iter.fixes_applied}<br>` : ''}
                            ${iter.sablon_markers_removed ? `Sablon Markers Removed: ${iter.sablon_markers_removed}<br>` : ''}
                            Template ID: ${iter.template_id || 'N/A'}
                        </div>
                    </div>
                `;
            });

            historyHTML += '</div>';

            // Show in modal
            showModal('Iteration History', historyHTML);
        }

        function downloadFinalTemplate() {
            /**
             * Download the final converted template
             */
            const templateId = conversionState.v2TemplateId;
            if (!templateId) {
                showAlert('error', 'No template available to download');
                return;
            }

            // Download using the correct template download endpoint
            // Note: This endpoint requires POST method, so we create a form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/api/templates/${templateId}/download`;
            form.style.display = 'none';
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        async function skipLearning() {
            // Analyze without learning from project
            try {
                showStatus('Analyzing template...', 'Using existing field mapping knowledge');

                const response = await fetch('/api/analyze-for-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_path: conversionState.templatePath
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    conversionState.suggestedMappings = data.suggested_mappings;
                    currentV1MergeData = data.v1_merge_data;
                    currentV2MergeData = data.v2_merge_data;

                    console.log('Merge data loaded (skip learning):', {
                        v1: currentV1MergeData ? 'loaded' : 'not available',
                        v2: currentV2MergeData ? 'loaded' : 'not available'
                    });

                    hideStatus();
                    showAlert('success', `Found ${data.suggested_mappings?.length || 0} suggested mappings`);
                    proceedToReviewStep();
                } else {
                    hideStatus();
                    showAlert('error', data.error || 'Analysis failed');
                }
            } catch (error) {
                hideStatus();
                showAlert('error', 'Analysis error: ' + error.message);
            }
        }

        // Step 3: Review Mappings
        function proceedToReviewStep() {
            hideStep(2);
            showStep(3);
            renderMappingReview();
        }

        // Store merge data globally
        let currentV1MergeData = null;
        let currentV2MergeData = null;
        let currentlySelectedMappingIndex = null;

        function renderMappingReview() {
            const container = document.getElementById('mappingReviewList');
            container.innerHTML = '';

            if (conversionState.suggestedMappings.length === 0) {
                container.innerHTML = '<p style="padding: 16px; color: #666;">No mappings to review. Proceeding with defaults.</p>';
                return;
            }

            conversionState.suggestedMappings.forEach((mapping, index) => {
                const card = document.createElement('div');
                card.className = `mapping-item ${mapping.confidence}-confidence`;
                card.style.cursor = 'pointer';
                card.style.padding = '12px';
                card.style.margin = '8px';
                card.style.borderRadius = '6px';
                card.onclick = () => selectMapping(index);

                card.innerHTML = `
                    <div style="margin-bottom: 6px; font-size: 11px; color: #666;">
                        Mapping #${index + 1}
                    </div>
                    <div style="margin-bottom: 4px;">
                        <code style="font-size: 12px; font-weight: bold; word-wrap: break-word; display: block; max-height: 2.4em; overflow: hidden; text-overflow: ellipsis; line-height: 1.2em;">${mapping.v1_field}</code>
                    </div>
                    <div style="margin-bottom: 6px;">
                        <code id="v2-display-${index}" style="font-size: 11px; color: #0066cc; word-wrap: break-word; display: block; max-height: 2.4em; overflow: hidden; text-overflow: ellipsis; line-height: 1.2em;">${mapping.v2_field}</code>
                    </div>
                    <div style="font-size: 11px;">
                        <span class="confidence-badge ${mapping.confidence}" style="padding: 2px 6px; border-radius: 3px; font-size: 10px;">${mapping.confidence.toUpperCase()}</span>
                        <span style="margin-left: 8px; color: #999;">${(mapping.coherence_score * 100).toFixed(0)}%</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function selectMapping(index) {
            currentlySelectedMappingIndex = index;
            const mapping = conversionState.suggestedMappings[index];

            // Highlight selected mapping
            document.querySelectorAll('.mapping-item').forEach((item, i) => {
                if (i === index) {
                    item.style.background = '#e3f2fd';
                    item.style.borderLeft = '4px solid #0066cc';
                } else {
                    item.style.background = '';
                    item.style.borderLeft = '';
                }
            });

            // Show data viewer
            document.getElementById('noMappingSelected').style.display = 'none';
            document.getElementById('dataViewer').style.display = 'block';

            // Render V1 data view
            renderV1DataView(mapping.v1_field);

            // Render V2 data tree
            renderV2DataTree(mapping.v2_field);

            // Set current path in search box
            document.getElementById('v2PathSearch').value = mapping.v2_field;
            updatePathPreview(mapping.v2_field);
        }

        // Column Browser State
        let columnBrowserState = {
            v1: { currentPath: [], data: null },
            v2: { currentPath: [], data: null }
        };

        // Render macOS Finder-style column browser
        function renderColumnBrowser(container, rootData, targetPath, browserId) {
            container.innerHTML = '';

            // Initialize state
            const state = columnBrowserState[browserId];
            state.data = rootData;

            // If target path provided, navigate to it
            if (targetPath && targetPath.length > 0) {
                state.currentPath = targetPath.slice(0, -1); // Navigate to parent
            } else {
                state.currentPath = [];
            }

            // Start with root column
            let currentData = rootData;
            const pathToRender = ['root', ...state.currentPath];

            // Render each column in the path
            for (let i = 0; i < pathToRender.length; i++) {
                const columnPath = pathToRender.slice(0, i + 1);
                const isLastColumn = i === pathToRender.length - 1;

                // Create column
                const column = document.createElement('div');
                column.className = 'data-column';
                column.style.cssText = `
                    min-width: 200px;
                    width: 200px;
                    border-right: 1px solid #e0e0e0;
                    background: white;
                    overflow-y: auto;
                    max-height: 100%;
                `;

                // Get children for this column
                if (i === 0) {
                    // Root column
                    renderColumnItems(column, rootData, [], targetPath, browserId);
                } else {
                    // Navigate to this level
                    let navData = rootData;
                    for (let j = 1; j < i; j++) {
                        const key = pathToRender[j];
                        if (navData && typeof navData === 'object') {
                            if (Array.isArray(navData)) {
                                navData = navData[0]; // Show first array item
                            } else {
                                navData = navData[key];
                            }
                        }
                    }

                    // Render children of current level
                    if (navData && typeof navData === 'object') {
                        const currentKey = pathToRender[i];
                        let childData = navData[currentKey];

                        if (Array.isArray(childData)) {
                            childData = childData[0]; // Show first array item
                        }

                        const currentPathArray = pathToRender.slice(1, i + 1);
                        renderColumnItems(column, childData, currentPathArray, targetPath, browserId);
                    }
                }

                container.appendChild(column);
            }

            // Scroll to show the last column
            container.scrollLeft = container.scrollWidth;
        }

        function renderColumnItems(column, data, currentPath, targetPath, browserId) {
            if (!data || typeof data !== 'object') {
                column.innerHTML = '<div style="padding: 12px; color: #999; font-size: 11px;">No children</div>';
                return;
            }

            const entries = Array.isArray(data)
                ? [['[0]', data[0]]] // For arrays, show first item
                : Object.entries(data);

            if (entries.length === 0) {
                column.innerHTML = '<div style="padding: 12px; color: #999; font-size: 11px;">Empty</div>';
                return;
            }

            entries.forEach(([key, value]) => {
                const item = document.createElement('div');
                const itemPath = [...currentPath, key];
                const isOnTargetPath = targetPath && itemPath.join('.') === targetPath.slice(0, itemPath.length).join('.');
                const isTarget = targetPath && itemPath.join('.') === targetPath.join('.');
                const hasChildren = value && typeof value === 'object';

                item.style.cssText = `
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 12px;
                    border-bottom: 1px solid #f0f0f0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    ${isTarget ? 'background: #ffd700; font-weight: bold; border-left: 3px solid #ff9800;' : ''}
                    ${isOnTargetPath && !isTarget ? 'background: #e3f2fd;' : ''}
                `;

                // Auto-scroll to selected item
                if (isTarget) {
                    setTimeout(() => {
                        item.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    }, 100);
                }

                item.addEventListener('mouseenter', () => {
                    if (!isTarget) item.style.background = '#f8f9fa';
                });

                item.addEventListener('mouseleave', () => {
                    if (isTarget) {
                        item.style.background = '#ffd700';
                        item.style.borderLeft = '3px solid #ff9800';
                    } else if (isOnTargetPath) {
                        item.style.background = '#e3f2fd';
                    } else {
                        item.style.background = 'white';
                    }
                });

                // Key name
                const keySpan = document.createElement('span');
                keySpan.textContent = key;
                keySpan.style.cssText = 'color: #005cc5; flex: 1;';
                item.appendChild(keySpan);

                // Value preview or arrow
                if (hasChildren) {
                    const arrow = document.createElement('span');
                    arrow.textContent = '‚ñ∂';
                    arrow.style.cssText = 'color: #999; font-size: 10px; margin-left: 8px;';
                    item.appendChild(arrow);
                } else {
                    const valueSpan = document.createElement('span');
                    valueSpan.textContent = JSON.stringify(value).substring(0, 30);
                    valueSpan.style.cssText = 'color: #d73a49; font-size: 10px; margin-left: 8px; max-width: 100px; overflow: hidden; text-overflow: ellipsis;';
                    item.appendChild(valueSpan);
                }

                // Click handler
                item.addEventListener('click', () => {
                    if (hasChildren) {
                        // Navigate to this item (show its children in next column)
                        columnBrowserState[browserId].currentPath = itemPath;

                        // Get the root data
                        const rootData = columnBrowserState[browserId].data;
                        renderColumnBrowser(column.parentElement, rootData, itemPath, browserId);
                    } else {
                        // Select this leaf value for v2
                        if (browserId === 'v2') {
                            selectV2Path(itemPath.join('.'));
                        }
                    }
                });

                column.appendChild(item);
            });
        }

        function renderV1DataView(v1Field) {
            const container = document.getElementById('v1ColumnBrowser');

            if (!currentV1MergeData) {
                container.innerHTML = '<div style="padding: 12px; color: #999; font-size: 11px;">V1 merge data not available. (Provide a project during learning to see data.)</div>';
                return;
            }

            // Unwrap JSON:API structure to get actual content
            let data = currentV1MergeData;
            if (data.data && data.data.attributes && data.data.attributes.content) {
                data = data.data.attributes.content;
            } else if (data.content) {
                data = data.content;
            }

            // Extract the path to this field
            const cleanField = v1Field.replace('=', '').replace(/\[0\]/g, '');
            const targetPath = cleanField.split('.').filter(p => p);

            // Render column browser
            renderColumnBrowser(container, data, targetPath, 'v1');
        }

        function renderV1CollapsibleTree(obj, targetPath, currentPath, depth) {
            if (!obj || typeof obj !== 'object' || depth > 10) return '';

            let html = '';
            const indent = '  '.repeat(depth);

            if (Array.isArray(obj)) {
                html += `<div style="color: #6f42c1; margin-left: ${depth * 12}px;">[array] showing first item</div>`;
                if (obj.length > 0) {
                    return html + renderV1CollapsibleTree(obj[0], targetPath, currentPath, depth);
                }
                return html;
            }

            for (const [key, value] of Object.entries(obj)) {
                const newPath = [...currentPath, key];
                const isOnPath = targetPath.length > newPath.length - 1 && targetPath[newPath.length - 1] === key;
                const isTarget = newPath.join('.') === targetPath.join('.');

                if (typeof value === 'object' && value !== null) {
                    // Expand if: on path to target OR at shallow depth (first 2 levels)
                    const shouldExpand = isOnPath || isTarget || depth < 2;

                    if (shouldExpand) {
                        const style = isTarget ? 'background: #fff9c4; font-weight: bold; padding: 2px 4px;' : '';
                        html += `<div style="margin-left: ${depth * 12}px; ${style}">`;
                        html += `<span style="color: #005cc5;">‚ñº ${key}</span>`;
                        html += renderV1CollapsibleTree(value, targetPath, newPath, depth + 1);
                        html += `</div>`;
                    } else {
                        // Collapsed - don't show children
                        html += `<div style="margin-left: ${depth * 12}px; color: #999;">`;
                        html += `<span>‚ñ∂ ${key}</span>`;
                        html += `</div>`;
                    }
                } else {
                    // Leaf value - show if on path OR at shallow depth
                    if (isOnPath || isTarget || depth < 3) {
                        const style = isTarget ? 'background: #fff9c4; font-weight: bold; padding: 2px 4px;' : '';
                        html += `<div style="margin-left: ${depth * 12}px; ${style}">`;
                        html += `<span style="color: #005cc5;">${key}</span>: `;
                        html += `<span style="color: #d73a49;">${JSON.stringify(value)}</span>`;
                        html += `</div>`;
                    }
                }
            }
            return html;
        }

        function renderV2DataTree(currentPath) {
            const container = document.getElementById('v2ColumnBrowser');

            if (!currentV2MergeData) {
                container.innerHTML = '<div style="padding: 12px; color: #999; font-size: 11px;">V2 merge data not available. (Provide a project during learning to see data.)</div>';
                return;
            }

            // Unwrap JSON:API structure to get actual content
            let data = currentV2MergeData;
            if (data.data && data.data.attributes && data.data.attributes.content) {
                data = data.data.attributes.content;
            } else if (data.content) {
                data = data.content;
            }

            // Parse current path
            const cleanPath = currentPath.replace(/{|}/g, '').replace(/\[0\]/g, '');
            const targetPath = cleanPath.split('.').filter(p => p);

            // Render column browser
            renderColumnBrowser(container, data, targetPath, 'v2');
        }

        function renderV2CollapsibleTree(obj, currentPath, targetPath, depth) {
            if (!obj || typeof obj !== 'object' || depth > 10) return '';

            let html = '';

            if (Array.isArray(obj)) {
                html += `<div style="color: #6f42c1; margin-left: ${depth * 12}px;">[array] showing first item</div>`;
                if (obj.length > 0) {
                    return html + renderV2CollapsibleTree(obj[0], currentPath, targetPath, depth);
                }
                return html;
            }

            for (const [key, value] of Object.entries(obj)) {
                const newPath = [...currentPath, key];
                const pathStr = newPath.join('.');
                const isOnPath = targetPath.length > newPath.length - 1 && targetPath[newPath.length - 1] === key;
                const isTarget = newPath.join('.') === targetPath.join('.');
                const isCollapsed = v2TreeCollapsedState[pathStr] === true;

                if (typeof value === 'object' && value !== null) {
                    // Expandable node
                    // Expand if: on target path OR explicitly expanded in state OR at shallow depth (first 2 levels)
                    // Check if explicitly set in state first, otherwise auto-expand shallow depths
                    let shouldExpand;
                    if (v2TreeCollapsedState[pathStr] !== undefined) {
                        // User has explicitly toggled this node
                        shouldExpand = v2TreeCollapsedState[pathStr] === false;
                    } else {
                        // Auto-expand first 2 levels OR nodes on target path
                        shouldExpand = depth < 2 || isOnPath || isTarget;
                    }

                    const arrow = shouldExpand ? '‚ñº' : '‚ñ∂';
                    const style = isTarget ? 'background: #fff9c4; font-weight: bold; padding: 2px 4px;' : '';

                    // Use data attribute instead of inline onclick for better reliability
                    html += `<div style="margin-left: ${depth * 12}px; ${style}">`;
                    html += `<span class="v2-tree-toggle" data-path="${pathStr}" style="color: #005cc5; cursor: pointer; user-select: none;">`;
                    html += `${arrow} ${key}`;
                    html += `</span>`;

                    if (shouldExpand) {
                        html += renderV2CollapsibleTree(value, newPath, targetPath, depth + 1);
                    }
                    html += `</div>`;
                } else {
                    // Leaf node - clickable to select
                    const style = isTarget ? 'background: #fff9c4; font-weight: bold; padding: 2px 4px;' : '';

                    html += `<div style="margin-left: ${depth * 12}px; ${style}">`;
                    html += `<span class="v2-path-select" data-path="${pathStr}" style="color: #005cc5; cursor: pointer; text-decoration: underline;">`;
                    html += key;
                    html += `</span>: `;
                    html += `<span style="color: #d73a49;">${JSON.stringify(value)}</span>`;
                    html += `</div>`;
                }
            }
            return html;
        }

        function toggleV2Node(pathStr) {
            // Toggle collapsed state
            v2TreeCollapsedState[pathStr] = !v2TreeCollapsedState[pathStr];

            // Re-render tree
            const currentPath = document.getElementById('v2PathSearch').value;
            renderV2DataTree(currentPath);
        }

        function selectV2Path(path) {
            document.getElementById('v2PathSearch').value = '{' + path + '}';
            updatePathPreview('{' + path + '}');
        }

        function updatePathPreview(path) {
            document.getElementById('selectedPathPreview').innerHTML = `
                <strong>Selected:</strong> <code>${path}</code>
            `;
        }

        function applySelectedV2Path() {
            if (currentlySelectedMappingIndex === null) {
                showAlert('error', 'No mapping selected');
                return;
            }

            const newPath = document.getElementById('v2PathSearch').value;
            if (!newPath) {
                showAlert('error', 'Please enter a v2 path');
                return;
            }

            const mapping = conversionState.suggestedMappings[currentlySelectedMappingIndex];

            // Update mapping
            conversionState.suggestedMappings[currentlySelectedMappingIndex].v2_field = newPath;
            conversionState.suggestedMappings[currentlySelectedMappingIndex].confidence = 'high';
            conversionState.overrides[mapping.v1_field] = newPath;

            // Update display in left panel
            document.getElementById(`v2-display-${currentlySelectedMappingIndex}`).textContent = newPath;

            // Re-render tree with new highlight
            renderV2DataTree(newPath);

            showAlert('success', 'Mapping updated!');
        }

        function overrideMapping(index) {
            // Legacy function - now just select the mapping
            selectMapping(index);
        }

        function backToLearning() {
            hideStep(3);
            showStep(2);
        }

        // Step 4: Final Conversion
        async function proceedWithConversion() {
            try {
                showProgress('Converting template with your mappings...');

                const response = await fetch('/api/convert-with-overrides', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_path: conversionState.templatePath,
                        overrides: conversionState.overrides,
                        project_id: conversionState.projectId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    conversionState.convertedFilePath = data.output_path;
                    hideProgress();
                    hideStep(3);
                    showStep(4);

                    // Set up template selection UI with smart naming
                    await setupTemplateSelectionUI();

                    // Auto-generate V1 document for comparison
                    if (conversionState.projectId) {
                        setTimeout(() => generateV1Document(), 500);
                    }

                    showAlert('success', `Converted successfully! ${data.overrides_applied} overrides applied, ${data.mappings_saved} mappings saved to database.`);
                } else {
                    showAlert('error', data.error || 'Conversion failed');
                    hideProgress();
                }
            } catch (error) {
                showAlert('error', 'Conversion error: ' + error.message);
                hideProgress();
            }
        }

        function sanitizeTemplateName(name) {
            // Remove or replace characters that might cause API issues
            // Keep: letters, numbers, spaces, hyphens, underscores
            // Remove: parentheses and other special characters
            return name
                .replace(/[()]/g, '') // Remove parentheses
                .replace(/[^\w\s-]/g, '') // Remove special chars except space, hyphen, underscore
                .replace(/\s+/g, ' ') // Normalize spaces
                .trim();
        }

        // Step 4: Template Selection Logic
        async function setupTemplateSelectionUI() {
            // Set up radio button listeners
            const radioButtons = document.querySelectorAll('input[name="v2_action"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', handleTemplateActionChange);
            });

            // Load V2 templates list for replacement option
            await loadV2TemplatesList();

            // Auto-generate name for "Create New" option (default)
            await generateSmartTemplateName();

            // Set up existing template selector listener
            const templateSelector = document.getElementById('existingV2Templates');
            if (templateSelector) {
                templateSelector.addEventListener('change', handleExistingTemplateSelection);
            }
        }

        function handleTemplateActionChange(event) {
            const action = event.target.value;
            const createSection = document.getElementById('createNewSection');
            const replaceSection = document.getElementById('replaceExistingSection');
            const uploadBtn = document.getElementById('uploadBtn');

            // Hide all sections first
            createSection.style.display = 'none';
            replaceSection.style.display = 'none';

            // Show appropriate section
            if (action === 'create') {
                createSection.style.display = 'block';
                uploadBtn.textContent = 'Upload to ScopeStack';
                uploadBtn.style.display = 'block';
            } else if (action === 'replace') {
                replaceSection.style.display = 'block';
                uploadBtn.textContent = 'Replace Template';
                uploadBtn.style.display = 'block';
            } else if (action === 'download') {
                uploadBtn.textContent = 'Download Only';
                uploadBtn.style.display = 'block';
            }
        }

        async function loadV2TemplatesList() {
            try {
                const response = await fetch('/api/templates/v2-list?check_health=false');
                const data = await response.json();

                if (response.ok && data.success) {
                    const selector = document.getElementById('existingV2Templates');
                    selector.innerHTML = '<option value="">Select a V2 template to replace...</option>';

                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.attributes.name;
                        option.dataset.health = 'unknown'; // Will check on selection
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load V2 templates:', error);
            }
        }

        async function generateSmartTemplateName() {
            const v1TemplateName = conversionState.templateName || 'Template';

            try {
                const response = await fetch('/api/templates/check-name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ v1_template_name: v1TemplateName })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const nameInput = document.getElementById('newTemplateName');
                    const collisionWarning = document.getElementById('nameCollisionWarning');

                    nameInput.value = data.suggested_name;

                    if (data.has_collision) {
                        collisionWarning.style.display = 'block';
                    } else {
                        collisionWarning.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to check template name:', error);
                // Fallback to basic naming
                autoPopulateTemplateNameFallback();
            }
        }

        async function handleExistingTemplateSelection(event) {
            const templateId = event.target.value;
            const warningDiv = document.getElementById('templateHealthWarning');
            const infoDiv = document.getElementById('templateInfoDisplay');

            if (!templateId) {
                warningDiv.style.display = 'none';
                infoDiv.style.display = 'none';
                return;
            }

            // Check template health
            try {
                const response = await fetch('/api/templates/v2-list?check_health=true');
                const data = await response.json();

                if (response.ok && data.success) {
                    const template = data.templates.find(t => t.id === templateId);

                    if (template && template.health) {
                        infoDiv.style.display = 'block';
                        infoDiv.innerHTML = `
                            <strong>Template:</strong> ${template.attributes.name}<br>
                            <strong>ID:</strong> ${template.id}<br>
                            <strong>Status:</strong> ${template.health.is_healthy ? '‚úÖ Healthy' : '‚ö†Ô∏è Corrupted'}
                        `;

                        if (!template.health.is_healthy) {
                            warningDiv.style.display = 'block';
                            warningDiv.innerHTML = `
                                ‚ö†Ô∏è <strong>Warning:</strong> This template is corrupted: ${template.health.issue}<br>
                                ${template.health.can_auto_recover ? '‚úì Auto-recovery will be attempted after upload.' : '‚ùå Cannot auto-recover.'}
                            `;
                        } else {
                            warningDiv.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to check template health:', error);
            }
        }

        function autoPopulateTemplateNameFallback() {
            // Fallback for when API is unavailable
            let originalName = conversionState.templateName || 'Template';
            let baseName = originalName.replace(/\.docx$/i, '');
            baseName = baseName.replace(/\s*\(Tag Template[^)]*\)/i, '');
            baseName = baseName.replace(/\s*Tag Template[^)]*$/i, '');

            const versionMatch = baseName.match(/\s+v(\d+)$/i);
            let newName;

            if (versionMatch) {
                const currentVersion = parseInt(versionMatch[1]);
                const nextVersion = currentVersion + 1;
                newName = baseName.replace(/\s+v\d+$/i, ` v${nextVersion}`) + ' Tag Template';
            } else {
                newName = `${baseName} Tag Template v1`;
            }

            newName = sanitizeTemplateName(newName);

            const nameInput = document.getElementById('newTemplateName');
            if (nameInput) {
                nameInput.value = newName;
            }
        }

        function autoPopulateTemplateName() {
            // This is now a wrapper that calls the smart name generator
            generateSmartTemplateName();
        }

        async function downloadConvertedTemplate() {
            if (!conversionState.convertedFilePath) {
                showAlert('error', 'No converted file available');
                return;
            }

            window.location.href = '/api/download';
        }

        async function uploadToPlatform() {
            // Get selected action
            const selectedAction = document.querySelector('input[name="v2_action"]:checked').value;

            // Handle download-only mode
            if (selectedAction === 'download') {
                await downloadConvertedTemplate();
                return;
            }

            // Get template name based on action
            let templateName;
            let templateId = null;

            if (selectedAction === 'create') {
                templateName = document.getElementById('newTemplateName').value;
                if (!templateName) {
                    showAlert('error', 'Please enter a template name');
                    return;
                }
            } else if (selectedAction === 'replace') {
                templateId = document.getElementById('existingV2Templates').value;
                if (!templateId) {
                    showAlert('error', 'Please select a template to replace');
                    return;
                }
                // Get template name from selector
                const selector = document.getElementById('existingV2Templates');
                templateName = selector.options[selector.selectedIndex].text;
            }

            // Sanitize template name
            templateName = sanitizeTemplateName(templateName);

            if (!templateName) {
                showAlert('error', 'Template name is invalid after sanitization');
                return;
            }

            try {
                showProgress(selectedAction === 'replace' ? 'Replacing template...' : 'Uploading to ScopeStack...');

                // Read the converted file and create FormData
                const formData = new FormData();
                formData.append('name', templateName);
                formData.append('template_format', 'v2');
                formData.append('include_formatting', 'true');

                // Add V1 template info for auto-recovery
                if (conversionState.templateId) {
                    formData.append('v1_template_id', conversionState.templateId);
                }
                if (conversionState.templateName) {
                    formData.append('v1_template_name', conversionState.templateName);
                }

                // Need to get the file blob first
                const fileResponse = await fetch('/api/download');
                const fileBlob = await fileResponse.blob();
                formData.append('template_file', fileBlob, 'converted_template.docx');

                const response = await fetch('/api/templates/create-or-update', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    hideProgress();

                    // Handle recovery notification
                    if (data.recovery_performed) {
                        showAlert('warning', `‚ö†Ô∏è ${data.message} Original issue: ${data.original_issue}`);
                    } else if (data.warning) {
                        showAlert('warning', `‚ö†Ô∏è ${data.message}`);
                    } else {
                        const action = data.action === 'updated' ? 'updated' : data.action === 'recovered' ? 'recovered' : 'created';
                        showAlert('success', `‚úì Template ${action}! ID: ${data.template_id} | ${data.message}`);
                    }

                    // Store v2 template ID and enable v2 document generation
                    conversionState.v2TemplateId = data.template_id;
                    const generateV2Btn = document.getElementById('generateV2Btn');
                    if (generateV2Btn) {
                        generateV2Btn.disabled = false;
                    }
                } else {
                    showAlert('error', data.error || 'Upload failed');
                    hideProgress();
                }
            } catch (error) {
                showAlert('error', 'Upload error: ' + error.message);
                hideProgress();
            }
        }

        async function generateV1Document() {
            const projectId = conversionState.projectId;
            const templateId = conversionState.templateId;

            if (!projectId) {
                showAlert('error', 'Project ID is required. Please provide one during the learning step.');
                return;
            }

            if (!templateId) {
                showAlert('error', 'No template selected. Please start over and select a template.');
                return;
            }

            const statusDiv = document.getElementById('documentGenStatus');
            const generateBtn = document.getElementById('generateV1Btn');

            try {
                generateBtn.disabled = true;
                statusDiv.innerHTML = '<span style="color: #0066cc;">üîÑ Generating V1 document... This may take 30-60 seconds</span>';

                const response = await fetch('/api/generate-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        template_id: templateId,
                        project_id: projectId,
                        document_name: 'V1_Before_Conversion',
                        generate_pdf: false
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (data.filename) {
                        // Store document path for AI improvement
                        conversionState.v1DocumentPath = data.filepath;

                        statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ V1 document generated! <a href="/api/download-generated/' + data.filename + '" download style="color: #0066cc; text-decoration: underline;">Download V1 Document</a></span>';

                        // Show AI improvement section if both documents are ready
                        checkShowAIImprovement();
                    } else {
                        statusDiv.innerHTML = '<span style="color: #ff9800;">‚ö†Ô∏è V1 document generated but no download available. ' + (data.message || 'No filename returned') + '</span>';
                        console.error('V1 document response missing filename:', data);
                    }
                } else {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Failed to generate V1 document: ' + (data.error || 'Unknown error') + '</span>';
                    if (data.details) {
                        console.error('V1 document generation error details:', data.details);
                    }
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error: ' + error.message + '</span>';
            } finally {
                generateBtn.disabled = false;
            }
        }

        async function generateV2Document() {
            const projectId = conversionState.projectId;
            const v2TemplateId = conversionState.v2TemplateId;

            if (!projectId) {
                showAlert('error', 'Project ID is required. Please provide one during the learning step.');
                return;
            }

            if (!v2TemplateId) {
                showAlert('error', 'No V2 template uploaded yet. Please upload the converted template first.');
                return;
            }

            const statusDiv = document.getElementById('documentGenStatus');
            const generateBtn = document.getElementById('generateV2Btn');

            try {
                generateBtn.disabled = true;
                const currentStatus = statusDiv.innerHTML;
                statusDiv.innerHTML = currentStatus + '<br><span style="color: #0066cc;">üîÑ Generating V2 document... This may take 30-60 seconds</span>';

                const response = await fetch('/api/generate-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        template_id: v2TemplateId,
                        project_id: projectId,
                        document_name: 'V2_After_Conversion',
                        generate_pdf: false
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (data.filename) {
                        // Store document path for AI improvement
                        conversionState.v2DocumentPath = data.filepath;

                        statusDiv.innerHTML = currentStatus + '<br><span style="color: #28a745;">‚úÖ V2 document generated! <a href="/api/download-generated/' + data.filename + '" download style="color: #0066cc; text-decoration: underline;">Download V2 Document</a></span>';

                        // Show AI improvement section if both documents are ready
                        checkShowAIImprovement();
                    } else {
                        statusDiv.innerHTML = currentStatus + '<br><span style="color: #ff9800;">‚ö†Ô∏è V2 document generated but no download available. ' + (data.message || 'No filename returned') + '</span>';
                        console.error('V2 document response missing filename:', data);
                    }
                } else {
                    statusDiv.innerHTML = currentStatus + '<br><span style="color: #dc3545;">‚ùå Failed to generate V2 document: ' + (data.error || 'Unknown error') + '</span>';
                    if (data.details) {
                        console.error('V2 document generation error details:', data.details);
                    }
                }
            } catch (error) {
                statusDiv.innerHTML += '<br><span style="color: #dc3545;">‚ùå Error: ' + error.message + '</span>';
            } finally {
                generateBtn.disabled = false;
            }
        }

        function checkShowAIImprovement() {
            // Show AI improvement section if both V1 and V2 documents are generated
            if (conversionState.v1DocumentPath && conversionState.v2DocumentPath) {
                const aiSection = document.getElementById('aiImprovementSection');
                if (aiSection) {
                    aiSection.style.display = 'block';
                }
            }
        }

        async function startAIImprovement() {
            const projectId = conversionState.projectId;
            const v1TemplateId = conversionState.templateId;
            const v2TemplateId = conversionState.v2TemplateId;
            const v1DocPath = conversionState.v1DocumentPath;
            const v2DocPath = conversionState.v2DocumentPath;

            if (!v1TemplateId || !v2TemplateId || !projectId) {
                showAlert('error', 'Missing template or project information');
                return;
            }

            if (!v1DocPath || !v2DocPath) {
                showAlert('error', 'Please generate both V1 and V2 documents first');
                return;
            }

            const statusDiv = document.getElementById('aiImprovementStatus');
            const improveBtn = document.getElementById('aiImproveBtn');

            try {
                improveBtn.disabled = true;
                statusDiv.innerHTML = '<span style="color: #2196f3;">üîÑ Starting AI-powered improvement...</span>';

                // Get AI settings
                const aiSettings = await fetch('/api/settings/ai').then(r => r.json());
                const provider = aiSettings.provider || 'openai';
                const maxIterations = aiSettings.max_iterations || 4;

                const response = await fetch('/api/ai-improve-conversion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        v1_template_id: v1TemplateId,
                        v2_template_id: v2TemplateId,
                        project_id: projectId,
                        v1_document_path: v1DocPath,
                        v2_document_path: v2DocPath,
                        ai_provider: provider,
                        max_iterations: maxIterations
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const iterations = data.iterations || [];
                    const finalSimilarity = (data.final_similarity * 100).toFixed(1);

                    let html = '<div style="margin-top: 12px; background: white; padding: 12px; border-radius: 4px; max-height: 400px; overflow-y: auto;">';

                    // Overall status
                    html += `<div style="color: #28a745; font-weight: bold; margin-bottom: 8px;">‚úÖ AI Improvement Complete!</div>`;
                    html += `<div style="color: #666; font-size: 12px; margin-bottom: 12px;">Final Similarity: ${finalSimilarity}%</div>`;

                    // Detailed iterations
                    iterations.forEach((iter, idx) => {
                        const sim = (iter.similarity * 100).toFixed(1);
                        html += `<div style="border-left: 3px solid #2196f3; padding-left: 8px; margin: 8px 0; font-size: 11px;">`;
                        html += `<div style="font-weight: bold;">Round ${iter.iteration}: ${sim}% similarity</div>`;

                        if (iter.changes_suggested > 0) {
                            html += `<div style="color: #666;">‚Ä¢ AI suggested ${iter.changes_suggested} changes, applied ${iter.changes_applied || 0}</div>`;
                        }

                        if (iter.ai_assessment) {
                            html += `<div style="color: #666; margin-top: 4px; font-style: italic;">"${iter.ai_assessment}"</div>`;
                        }

                        if (iter.ai_confidence) {
                            const confidencePct = (iter.ai_confidence * 100).toFixed(0);
                            html += `<div style="color: #666;">‚Ä¢ AI Confidence: ${confidencePct}%</div>`;
                        }

                        html += `<div style="color: #999; margin-top: 4px;">Status: ${iter.status}</div>`;
                        html += `</div>`;
                    });

                    // Show DocX Templater errors from backend
                    if (data.template_errors && data.template_errors.length > 0) {
                        html += `<div style="border: 1px solid #ff9800; background: #fff3e0; padding: 8px; margin-top: 12px; border-radius: 4px;">`;
                        html += `<div style="font-weight: bold; color: #f57c00; margin-bottom: 4px;">‚ö†Ô∏è DocX Templater Syntax Errors (${data.template_errors.length}):</div>`;
                        data.template_errors.slice(0, 5).forEach(err => {
                            html += `<div style="font-size: 10px; color: #666; margin: 2px 0;">‚Ä¢ ${err.error_text}</div>`;
                        });
                        if (data.template_errors.length > 5) {
                            html += `<div style="font-size: 10px; color: #999; margin-top: 4px;">...and ${data.template_errors.length - 5} more</div>`;
                        }
                        html += `</div>`;
                    }

                    html += '</div>';
                    statusDiv.innerHTML = html;

                    // Show message to regenerate template
                    if (parseFloat(finalSimilarity) < 50) {
                        showAlert('warning', `Similarity is low (${finalSimilarity}%). Check for DocX Templater syntax errors in the V2 template.`);
                    } else {
                        showAlert('success', `AI improvement complete! Similarity: ${finalSimilarity}%.`);
                    }
                } else {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå AI improvement failed: ' + (data.error || 'Unknown error') + '</span>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error: ' + error.message + '</span>';
            } finally {
                improveBtn.disabled = false;
            }
        }

        async function startRecursiveAIImprovement() {
            const projectId = conversionState.projectId;
            const v1TemplateId = conversionState.templateId;
            const v2TemplateId = conversionState.v2TemplateId;

            if (!v1TemplateId || !v2TemplateId || !projectId) {
                showAlert('error', 'Missing template or project information');
                return;
            }

            const statusDiv = document.getElementById('aiImprovementStatus');
            const improveBtn = document.getElementById('aiImproveBtn');

            try {
                improveBtn.disabled = true;
                statusDiv.innerHTML = '<div style="color: #2196f3; font-weight: bold;">üîÑ Starting recursive AI improvement...</div>';

                // Show in status bar
                showStatus('üîÑ Recursive AI Improvement', 'Initializing...');

                // Get AI settings
                const aiSettings = await fetch('/api/settings/ai').then(r => r.json());
                const provider = aiSettings.provider || 'openai';
                const maxIterations = aiSettings.max_iterations || 4;

                updateStatus('üîÑ Recursive AI Improvement', `Using ${provider}, max ${maxIterations} iterations`);

                updateStatus('üîÑ Recursive AI Improvement', 'Running AI analysis and fixes... This may take a few minutes.');

                const response = await fetch('/api/ai-recursive-improve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        v1_template_id: v1TemplateId,
                        v2_template_id: v2TemplateId,
                        project_id: projectId,
                        ai_provider: provider,
                        max_iterations: maxIterations
                    })
                });

                const data = await response.json();

                updateStatus('üîÑ Processing Results', 'Analyzing iteration data...');

                if (response.ok && data.success) {
                    const iterations = data.iterations || [];
                    const finalSimilarity = (data.final_similarity * 100).toFixed(1);
                    const finalTemplateId = data.final_template_id;
                    const finalStatus = data.final_status;

                    let html = '<div style="margin-top: 12px; background: white; padding: 12px; border-radius: 4px; max-height: 500px; overflow-y: auto;">';

                    // Overall status
                    const statusIcon = finalStatus === 'success' ? '‚úÖ' : finalStatus.includes('no_fixes') ? '‚ö†Ô∏è' : 'üîÑ';
                    html += `<div style="font-weight: bold; margin-bottom: 8px; color: ${finalStatus === 'success' ? '#28a745' : '#ff9800'};">${statusIcon} Recursive Improvement Complete!</div>`;
                    html += `<div style="color: #666; font-size: 12px; margin-bottom: 4px;">Final Similarity: ${finalSimilarity}%</div>`;
                    html += `<div style="color: #666; font-size: 12px; margin-bottom: 12px;">Final Template ID: ${finalTemplateId}</div>`;

                    // Detailed iterations
                    iterations.forEach((iter, idx) => {
                        const sim = (iter.similarity * 100).toFixed(1);
                        const statusColor = iter.status === 'success' ? '#28a745' : iter.status.includes('fail') ? '#dc3545' : '#2196f3';

                        html += `<div style="border-left: 3px solid ${statusColor}; padding-left: 8px; margin: 8px 0; font-size: 11px;">`;
                        html += `<div style="font-weight: bold;">Iteration ${iter.iteration}: ${sim}% similarity</div>`;
                        html += `<div style="color: #666;">‚Ä¢ Syntax Errors: ${iter.syntax_errors || 0}</div>`;

                        if (iter.fixes_applied > 0) {
                            html += `<div style="color: #28a745;">‚Ä¢ Applied ${iter.fixes_applied} AI fixes</div>`;

                            if (iter.fixes_detail && iter.fixes_detail.length > 0) {
                                html += `<div style="margin-left: 12px; margin-top: 4px; font-size: 10px; color: #666;">`;
                                iter.fixes_detail.forEach(fix => {
                                    html += `<div>‚Üí ${fix.error}: ${fix.fix}</div>`;
                                });
                                html += `</div>`;
                            }
                        }

                        // Show AI reasoning if available
                        if (iter.ai_reasoning) {
                            html += `<div style="margin-top: 6px; padding: 6px; background: #f8f9fa; border-radius: 3px; font-size: 10px;">`;
                            html += `<div style="font-weight: bold; color: #495057;">AI Analysis:</div>`;
                            html += `<div style="color: #6c757d; margin-top: 2px;">${iter.ai_reasoning}</div>`;
                            if (iter.ai_confidence) {
                                html += `<div style="color: #6c757d; margin-top: 2px;">Confidence: ${(iter.ai_confidence * 100).toFixed(0)}%</div>`;
                            }
                            html += `</div>`;
                        }

                        html += `<div style="color: #999; margin-top: 4px;">Status: ${iter.status}</div>`;
                        if (iter.template_id) {
                            html += `<div style="color: #999; font-size: 10px;">Template: ${iter.template_id}</div>`;
                        }
                        html += `</div>`;
                    });

                    html += '</div>';
                    statusDiv.innerHTML = html;

                    // Update state with final template ID and session ID
                    conversionState.v2TemplateId = finalTemplateId;
                    conversionState.sessionId = data.session_id;

                    // Update status bar with final result
                    if (finalStatus === 'success') {
                        updateStatus('‚úÖ AI Improvement Complete', `Success! ${finalSimilarity}% similarity. Template: ${finalTemplateId}`);
                        showAlert('success', `Success! Reached ${finalSimilarity}% similarity. Final template: ${finalTemplateId}`);
                        setTimeout(hideStatus, 5000);
                    } else if (finalStatus.includes('no_fixes')) {
                        updateStatus('‚ö†Ô∏è AI Improvement Complete', `No more fixes possible. ${finalSimilarity}% similarity. Template: ${finalTemplateId}`);
                        showAlert('warning', `AI could not suggest more fixes. Final similarity: ${finalSimilarity}%`);
                        setTimeout(hideStatus, 5000);
                        // Show continuation UI if not at success
                        showContinuationUI(data.session_id, finalSimilarity, iterations.length);
                    } else {
                        updateStatus('üîÑ AI Improvement Complete', `Process finished with ${finalSimilarity}% similarity. Template: ${finalTemplateId}`);
                        showAlert('info', `Process completed with ${finalSimilarity}% similarity. Check iteration details above.`);
                        setTimeout(hideStatus, 5000);
                        // Show continuation UI if can continue
                        if (data.can_continue) {
                            showContinuationUI(data.session_id, finalSimilarity, iterations.length);
                        }
                    }
                } else {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Recursive improvement failed: ' + (data.error || 'Unknown error') + '</span>';
                    updateStatus('‚ùå AI Improvement Failed', data.error || 'Unknown error');
                    setTimeout(hideStatus, 5000);
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error: ' + error.message + '</span>';
                updateStatus('‚ùå Error', error.message);
                setTimeout(hideStatus, 5000);
            } finally {
                improveBtn.disabled = false;
            }
        }

        function showContinuationUI(sessionId, currentSimilarity, totalIterations) {
            const continuationSection = document.getElementById('aiContinuationSection');
            const sessionInfo = document.getElementById('sessionInfo');

            // Populate session info
            sessionInfo.innerHTML = `
                <div style="font-weight: bold; color: #856404;">Session: ${sessionId}</div>
                <div style="color: #666;">Current Similarity: ${currentSimilarity}%</div>
                <div style="color: #666;">Total Iterations: ${totalIterations}</div>
            `;

            continuationSection.style.display = 'block';
        }

        async function continueImprovement() {
            const sessionId = conversionState.sessionId;
            const userFeedback = document.getElementById('userFeedback').value;
            const additionalIterations = parseInt(document.getElementById('additionalIterations').value) || 4;
            const continueBtn = document.getElementById('continueBtn');
            const statusDiv = document.getElementById('aiImprovementStatus');

            if (!sessionId) {
                showAlert('error', 'No active session found');
                return;
            }

            try {
                continueBtn.disabled = true;
                statusDiv.innerHTML = '<div style="color: #2196f3; font-weight: bold;">üîÑ Continuing improvement with your feedback...</div>';

                showStatus('üîÑ Continuing Improvement', `Running ${additionalIterations} more iterations...`);

                const response = await fetch('/api/ai-continue-improvement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_feedback: userFeedback,
                        additional_iterations: additionalIterations
                    })
                });

                const data = await response.json();

                updateStatus('üîÑ Processing Results', 'Analyzing iteration data...');

                if (response.ok && data.success) {
                    // Hide continuation UI
                    document.getElementById('aiContinuationSection').style.display = 'none';

                    // Update the improvement status with new results
                    const iterations = data.iterations || [];
                    const finalSimilarity = (data.final_similarity * 100).toFixed(1);
                    const finalTemplateId = data.final_template_id;
                    const finalStatus = data.final_status;

                    let html = '<div style="margin-top: 12px; background: white; padding: 12px; border-radius: 4px; max-height: 500px; overflow-y: auto;">';

                    const statusIcon = finalStatus === 'success' ? '‚úÖ' : finalStatus.includes('no_fixes') ? '‚ö†Ô∏è' : 'üîÑ';
                    html += `<div style="font-weight: bold; margin-bottom: 8px; color: ${finalStatus === 'success' ? '#28a745' : '#ff9800'};">${statusIcon} Continued Improvement Complete!</div>`;
                    html += `<div style="color: #666; font-size: 12px; margin-bottom: 4px;">Final Similarity: ${finalSimilarity}%</div>`;
                    html += `<div style="color: #666; font-size: 12px; margin-bottom: 12px;">Final Template ID: ${finalTemplateId}</div>`;

                    // Show all iterations
                    iterations.forEach((iter, idx) => {
                        const sim = (iter.similarity * 100).toFixed(1);
                        const statusColor = iter.status === 'success' ? '#28a745' : iter.status.includes('fail') ? '#dc3545' : '#2196f3';

                        html += `<div style="border-left: 3px solid ${statusColor}; padding-left: 8px; margin: 8px 0; font-size: 11px;">`;
                        html += `<div style="font-weight: bold;">Iteration ${iter.iteration}: ${sim}% similarity</div>`;
                        html += `<div style="color: #666;">‚Ä¢ Syntax Errors: ${iter.syntax_errors || 0}</div>`;

                        if (iter.fixes_applied > 0) {
                            html += `<div style="color: #28a745;">‚Ä¢ Applied ${iter.fixes_applied} AI fixes</div>`;
                        }

                        if (iter.ai_reasoning) {
                            html += `<div style="margin-top: 6px; padding: 6px; background: #f8f9fa; border-radius: 3px; font-size: 10px;">`;
                            html += `<div style="font-weight: bold; color: #495057;">AI Analysis:</div>`;
                            html += `<div style="color: #6c757d; margin-top: 2px;">${iter.ai_reasoning}</div>`;
                            if (iter.ai_confidence) {
                                html += `<div style="color: #6c757d; margin-top: 2px;">Confidence: ${(iter.ai_confidence * 100).toFixed(0)}%</div>`;
                            }
                            html += `</div>`;
                        }

                        html += `<div style="color: #999; margin-top: 4px;">Status: ${iter.status}</div>`;
                        html += `</div>`;
                    });

                    html += '</div>';
                    statusDiv.innerHTML = html;

                    // Update state
                    conversionState.v2TemplateId = finalTemplateId;
                    conversionState.sessionId = data.session_id;

                    // Update status bar
                    if (finalStatus === 'success') {
                        updateStatus('‚úÖ Improvement Complete', `Success! ${finalSimilarity}% similarity`);
                        showAlert('success', `Success! Reached ${finalSimilarity}% similarity`);
                        setTimeout(hideStatus, 5000);
                    } else {
                        updateStatus('‚ö†Ô∏è Improvement Complete', `${finalSimilarity}% similarity achieved`);
                        setTimeout(hideStatus, 5000);
                        // Show continuation UI again if can continue
                        if (data.can_continue) {
                            showContinuationUI(data.session_id, finalSimilarity, iterations.length);
                        }
                    }
                } else {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Continue failed: ' + (data.error || 'Unknown error') + '</span>';
                    updateStatus('‚ùå Continue Failed', data.error || 'Unknown error');
                    setTimeout(hideStatus, 5000);
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error: ' + error.message + '</span>';
                updateStatus('‚ùå Error', error.message);
                setTimeout(hideStatus, 5000);
            } finally {
                continueBtn.disabled = false;
                // Clear feedback textarea
                document.getElementById('userFeedback').value = '';
            }
        }

        async function saveSessionForLater() {
            const sessionId = conversionState.sessionId;
            if (!sessionId) {
                showAlert('error', 'No active session found');
                return;
            }

            showAlert('success', `Session ${sessionId} saved! You can resume it later from the Saved Sessions section.`);

            // Hide continuation UI
            document.getElementById('aiContinuationSection').style.display = 'none';

            // Load and show saved sessions
            loadSavedSessions();
        }

        async function loadSavedSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();

                if (response.ok && data.success) {
                    const sessions = data.sessions;

                    // Update in-workflow saved sessions section
                    const sessionsList = document.getElementById('sessionsList');
                    const savedSessionsSection = document.getElementById('savedSessionsSection');

                    // Update home screen saved sessions section
                    const homeSessionsList = document.getElementById('homeScreenSessionsList');
                    const homeSessionsSection = document.getElementById('homeScreenSavedSessions');

                    if (sessions.length > 0) {
                        // Build HTML for in-workflow section (compact view)
                        let workflowHtml = '';
                        sessions.forEach(session => {
                            workflowHtml += `
                                <div style="background: white; padding: 8px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <div style="font-weight: bold; font-size: 12px;">${session.session_name}</div>
                                    <div style="font-size: 11px; color: #666;">Similarity: ${(session.current_similarity * 100).toFixed(1)}%</div>
                                    <div style="font-size: 11px; color: #666;">Iterations: ${session.total_iterations}</div>
                                    <div style="font-size: 11px; color: #666;">Updated: ${new Date(session.updated_at).toLocaleString()}</div>
                                    <button onclick="resumeSession('${session.session_id}')" class="btn-primary" style="margin-top: 4px; padding: 4px 8px; font-size: 11px;">
                                        Resume
                                    </button>
                                    <button onclick="deleteSession('${session.session_id}')" class="btn-secondary" style="margin-top: 4px; padding: 4px 8px; font-size: 11px;">
                                        Delete
                                    </button>
                                </div>
                            `;
                        });

                        // Build HTML for home screen (card view)
                        let homeHtml = '';
                        sessions.forEach(session => {
                            homeHtml += `
                                <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #4caf50; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #2e7d32;">${session.session_name}</div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        üìä Similarity: <strong>${(session.current_similarity * 100).toFixed(1)}%</strong>
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        üîÑ Iterations: ${session.total_iterations}
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-bottom: 12px;">
                                        Updated: ${new Date(session.updated_at).toLocaleString()}
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="event.stopPropagation(); resumeSessionFromHome('${session.session_id}')" class="btn-primary" style="flex: 1; padding: 8px;">
                                            Resume Session
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteSession('${session.session_id}')" class="btn-secondary" style="padding: 8px;">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            `;
                        });

                        sessionsList.innerHTML = workflowHtml;
                        savedSessionsSection.style.display = 'block';

                        homeSessionsList.innerHTML = homeHtml;
                        homeSessionsSection.style.display = 'block';
                    } else {
                        savedSessionsSection.style.display = 'none';
                        homeSessionsSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        async function resumeSession(sessionId) {
            try {
                // Get session details
                const response = await fetch(`/api/sessions/${sessionId}`);
                const data = await response.json();

                if (response.ok && data.success) {
                    const session = data.session;

                    // Update conversion state
                    conversionState.sessionId = sessionId;
                    conversionState.templateId = session.v1_template_id;
                    conversionState.v2TemplateId = session.v2_template_id;
                    conversionState.projectId = session.project_id;

                    // Show continuation UI
                    showContinuationUI(sessionId, session.current_similarity * 100, session.total_iterations);

                    // Hide saved sessions section
                    document.getElementById('savedSessionsSection').style.display = 'none';

                    showAlert('info', `Resumed session: ${session.session_name}`);
                }
            } catch (error) {
                showAlert('error', `Failed to resume session: ${error.message}`);
            }
        }

        async function resumeSessionFromHome(sessionId) {
            try {
                // Get session details
                const response = await fetch(`/api/sessions/${sessionId}`);
                const data = await response.json();

                if (response.ok && data.success) {
                    const session = data.session;

                    // Update conversion state
                    conversionState.sessionId = sessionId;
                    conversionState.templateId = session.v1_template_id;
                    conversionState.v2TemplateId = session.v2_template_id;
                    conversionState.projectId = session.project_id;
                    conversionState.step = 4;  // Jump to output step

                    // Hide home screen
                    // workflowSelector has been removed in simplified single-workflow UX
                    document.getElementById('homeScreenSavedSessions').style.display = 'none';

                    // Show convert workflow and jump to step 4 (output)
                    showWorkflow('convert');
                    hideStep(1);
                    hideStep(2);
                    hideStep(3);
                    showStep(4);

                    // Show AI improvement section
                    document.getElementById('aiImprovementSection').style.display = 'block';

                    // Show continuation UI with session details
                    showContinuationUI(sessionId, session.current_similarity * 100, session.total_iterations);

                    // Display session history in the AI improvement status
                    displaySessionHistory(session);

                    showAlert('info', `Resumed session: ${session.session_name}`);
                }
            } catch (error) {
                showAlert('error', `Failed to resume session: ${error.message}`);
            }
        }

        function displaySessionHistory(session) {
            const statusDiv = document.getElementById('aiImprovementStatus');
            const iterations = session.iterations || [];

            if (iterations.length === 0) {
                statusDiv.innerHTML = '<div style="color: #666;">No iteration history available yet.</div>';
                return;
            }

            // Generate comprehensive summary
            const summary = generateSessionSummary(session);

            let html = '<div style="margin-top: 12px; background: white; padding: 12px; border-radius: 4px; max-height: 600px; overflow-y: auto;">';

            // Overall Summary Section
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">`;
            html += `<div style="font-weight: bold; font-size: 16px; margin-bottom: 12px;">üìä Session Summary</div>`;
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">`;
            html += `<div><div style="opacity: 0.8; font-size: 11px;">Current Progress</div><div style="font-size: 20px; font-weight: bold;">${(session.current_similarity * 100).toFixed(1)}%</div></div>`;
            html += `<div><div style="opacity: 0.8; font-size: 11px;">Total Iterations</div><div style="font-size: 20px; font-weight: bold;">${session.total_iterations}</div></div>`;
            html += `<div><div style="opacity: 0.8; font-size: 11px;">Fixes Applied</div><div style="font-size: 20px; font-weight: bold;">${summary.totalFixesApplied}</div></div>`;
            html += `<div><div style="opacity: 0.8; font-size: 11px;">Errors Remaining</div><div style="font-size: 20px; font-weight: bold;">${summary.lastErrorCount}</div></div>`;
            html += `</div></div>`;

            // What's Working Section
            if (summary.improvements.length > 0) {
                html += `<div style="background: #d4edda; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #28a745;">`;
                html += `<div style="font-weight: bold; color: #155724; margin-bottom: 8px;">‚úÖ Progress Made</div>`;
                html += `<ul style="margin: 0; padding-left: 20px; color: #155724; font-size: 12px;">`;
                summary.improvements.forEach(improvement => {
                    html += `<li>${improvement}</li>`;
                });
                html += `</ul></div>`;
            }

            // What Needs Attention Section
            if (summary.issues.length > 0) {
                html += `<div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #ffc107;">`;
                html += `<div style="font-weight: bold; color: #856404; margin-bottom: 8px;">‚ö†Ô∏è Needs Attention</div>`;
                html += `<ul style="margin: 0; padding-left: 20px; color: #856404; font-size: 12px;">`;
                summary.issues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += `</ul></div>`;
            }

            // Recent AI Insights
            if (summary.recentInsights.length > 0) {
                html += `<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #2196f3;">`;
                html += `<div style="font-weight: bold; color: #0d47a1; margin-bottom: 8px;">ü§ñ Recent AI Insights</div>`;
                summary.recentInsights.forEach(insight => {
                    html += `<div style="font-size: 11px; color: #1565c0; margin-bottom: 6px; padding: 6px; background: rgba(255,255,255,0.5); border-radius: 4px;">`;
                    html += `<div style="font-style: italic;">"${insight.reasoning}"</div>`;
                    html += `<div style="font-size: 10px; color: #666; margin-top: 4px;">Confidence: ${(insight.confidence * 100).toFixed(0)}% ‚Ä¢ Iteration ${insight.iteration}</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // User Feedback History
            if (session.user_feedback && session.user_feedback.length > 0) {
                html += `<div style="background: #f3e5f5; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #9c27b0;">`;
                html += `<div style="font-weight: bold; color: #4a148c; margin-bottom: 8px;">üí¨ Your Previous Feedback</div>`;
                session.user_feedback.forEach(fb => {
                    html += `<div style="font-size: 11px; color: #6a1b9a; margin-bottom: 6px; padding: 6px; background: rgba(255,255,255,0.5); border-radius: 4px;">`;
                    html += `<div>"${fb.feedback}"</div>`;
                    html += `<div style="font-size: 10px; color: #666; margin-top: 4px;">After iteration ${fb.iteration_context}</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Iteration Timeline
            html += `<details style="margin-top: 12px;">`;
            html += `<summary style="cursor: pointer; font-weight: bold; color: #666; padding: 8px; background: #f5f5f5; border-radius: 4px;">üìã View Full Iteration History (${iterations.length} iterations)</summary>`;
            html += `<div style="margin-top: 12px;">`;

            iterations.forEach((iter, idx) => {
                const sim = (iter.similarity * 100).toFixed(1);
                const statusColor = iter.status === 'success' ? '#28a745' : iter.status.includes('fail') ? '#dc3545' : '#2196f3';

                html += `<div style="border-left: 3px solid ${statusColor}; padding-left: 8px; margin: 8px 0; font-size: 11px;">`;
                html += `<div style="font-weight: bold;">Iteration ${iter.iteration}: ${sim}% similarity</div>`;
                html += `<div style="color: #666;">‚Ä¢ Syntax Errors: ${iter.syntax_errors || 0}</div>`;

                if (iter.fixes_applied > 0) {
                    html += `<div style="color: #28a745;">‚Ä¢ Applied ${iter.fixes_applied} AI fixes</div>`;
                }

                if (iter.ai_reasoning) {
                    html += `<div style="margin-top: 6px; padding: 6px; background: #f8f9fa; border-radius: 3px; font-size: 10px;">`;
                    html += `<div style="font-weight: bold; color: #495057;">AI Analysis:</div>`;
                    html += `<div style="color: #6c757d; margin-top: 2px;">${iter.ai_reasoning}</div>`;
                    if (iter.ai_confidence) {
                        html += `<div style="color: #6c757d; margin-top: 2px;">Confidence: ${(iter.ai_confidence * 100).toFixed(0)}%</div>`;
                    }
                    html += `</div>`;
                }

                html += `<div style="color: #999; margin-top: 4px;">Status: ${iter.status}</div>`;
                html += `</div>`;
            });

            html += `</div></details>`;
            html += '</div>';
            statusDiv.innerHTML = html;
        }

        function generateSessionSummary(session) {
            const iterations = session.iterations || [];
            const summary = {
                totalFixesApplied: 0,
                lastErrorCount: 0,
                improvements: [],
                issues: [],
                recentInsights: []
            };

            // Calculate total fixes
            iterations.forEach(iter => {
                summary.totalFixesApplied += (iter.fixes_applied || 0);
            });

            // Get last error count
            if (iterations.length > 0) {
                summary.lastErrorCount = iterations[iterations.length - 1].syntax_errors || 0;
            }

            // Analyze progress trend
            if (iterations.length >= 2) {
                const firstSim = iterations[0].similarity * 100;
                const lastSim = iterations[iterations.length - 1].similarity * 100;
                const improvement = lastSim - firstSim;

                if (improvement > 20) {
                    summary.improvements.push(`Significant improvement: ${improvement.toFixed(1)}% increase in similarity`);
                } else if (improvement > 5) {
                    summary.improvements.push(`Moderate improvement: ${improvement.toFixed(1)}% increase in similarity`);
                } else if (improvement > 0) {
                    summary.improvements.push(`Small improvement: ${improvement.toFixed(1)}% increase in similarity`);
                }
            }

            // Check for declining trends
            if (iterations.length >= 3) {
                const recent3 = iterations.slice(-3);
                const similarities = recent3.map(i => i.similarity);

                if (similarities[2] < similarities[1] && similarities[1] < similarities[0]) {
                    summary.issues.push('Similarity has been declining in recent iterations');
                }
            }

            // Check if stuck
            if (iterations.length >= 2) {
                const lastTwo = iterations.slice(-2);
                if (Math.abs(lastTwo[0].similarity - lastTwo[1].similarity) < 0.01) {
                    summary.issues.push('Progress appears to have stalled (similarity not changing)');
                }
            }

            // Check error count trend
            if (iterations.length >= 2) {
                const lastErrorCount = iterations[iterations.length - 1].syntax_errors || 0;
                const prevErrorCount = iterations[iterations.length - 2].syntax_errors || 0;

                if (lastErrorCount === 0) {
                    summary.improvements.push('No syntax errors remaining!');
                } else if (lastErrorCount < prevErrorCount) {
                    summary.improvements.push(`Reduced errors from ${prevErrorCount} to ${lastErrorCount}`);
                } else if (lastErrorCount > prevErrorCount) {
                    summary.issues.push(`Error count increased from ${prevErrorCount} to ${lastErrorCount}`);
                }
            }

            // Check for low similarity with no errors
            const lastIter = iterations[iterations.length - 1];
            if (lastIter && (lastIter.syntax_errors || 0) === 0 && lastIter.similarity < 0.7) {
                summary.issues.push('No syntax errors but similarity is low - may need mapping improvements');
            }

            // Get recent AI insights (last 3 with reasoning)
            const withReasoning = iterations.filter(i => i.ai_reasoning).slice(-3);
            summary.recentInsights = withReasoning.map(i => ({
                reasoning: i.ai_reasoning,
                confidence: i.ai_confidence || 0,
                iteration: i.iteration
            }));

            // Check for repeated failed iterations
            const recentStatuses = iterations.slice(-3).map(i => i.status);
            if (recentStatuses.every(s => s.includes('fail') || s.includes('no_fixes'))) {
                summary.issues.push('AI unable to suggest fixes in recent iterations - manual review may be needed');
            }

            // Add general status based on similarity
            const currentSim = session.current_similarity * 100;
            if (currentSim >= 90) {
                summary.improvements.push('Excellent similarity achieved - nearly complete!');
            } else if (currentSim >= 70) {
                summary.improvements.push('Good progress - majority of content is matching');
            } else if (currentSim >= 50) {
                // Already covered by improvements calculation
            } else {
                summary.issues.push('Low similarity - significant work still needed');
            }

            return summary;
        }

        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) {
                return;
            }

            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('success', 'Session deleted');
                    loadSavedSessions();  // Reload list
                }
            } catch (error) {
                showAlert('error', `Failed to delete session: ${error.message}`);
            }
        }

        // Load saved sessions on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSavedSessions();
        });

        function startNewConversion() {
            // Reset state
            conversionState = {
                step: 1,
                inputMethod: null,
                templatePath: null,
                templateId: null,
                projectId: null,
                suggestedMappings: [],
                overrides: {},
                convertedFilePath: null,
                v2TemplateId: null,
                v1DocumentPath: null,
                v2DocumentPath: null,
                sessionId: null
            };

            // Reset UI
            hideStep(4);
            showStep(1);
            document.getElementById('uploadMethodCard').classList.remove('selected');
            document.getElementById('platformMethodCard').classList.remove('selected');
            document.getElementById('uploadInterface').style.display = 'none';
            document.getElementById('platformInterface').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('convertProjectId').value = '';
        }

        // Helper functions for step management
        function showStep(stepNum) {
            // Handle both old review step and new improvement step for step 3
            if (stepNum === 3) {
                // Show improvement step (new integrated flow)
                const improvementStep = document.getElementById('step3-improvement');
                if (improvementStep) {
                    improvementStep.style.display = 'block';
                    conversionState.step = stepNum;
                    return;
                }
            }

            const stepId = `step${stepNum}-${getStepName(stepNum)}`;
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.style.display = 'block';
                conversionState.step = stepNum;
            }
        }

        function hideStep(stepNum) {
            // Handle both old review step and new improvement step for step 3
            if (stepNum === 3) {
                const improvementStep = document.getElementById('step3-improvement');
                if (improvementStep) {
                    improvementStep.style.display = 'none';
                }
            }

            const stepId = `step${stepNum}-${getStepName(stepNum)}`;
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.style.display = 'none';
            }
        }

        function getStepName(stepNum) {
            const names = {1: 'input', 2: 'learn', 3: 'review', 4: 'output'};
            return names[stepNum] || 'unknown';
        }

        function showProgress(message) {
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            if (progress && progressBar) {
                progress.style.display = 'block';
                progressBar.textContent = message;
            }
        }

        function hideProgress() {
            const progress = document.getElementById('progress');
            if (progress) {
                progress.style.display = 'none';
            }
        }
    </script>
</body>
</html>
